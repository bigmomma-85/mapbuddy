<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MapBuddy — Asset → KML / GeoJSON / Shapefile</title>
  <meta name="color-scheme" content="light only" />
  <style>
    :root{
      --bg: #f4f8fb;
      --card: #ffffff;
      --text: #0f2233;
      --muted:#5b6b7b;
      --accent:#2563eb;
      --accent-2:#0ea5e9;
      --accent-3:#22c55e;
      --stroke:#e6eef6;
      --shadow: 0 10px 30px rgba(16,24,40,.06);
      --radius:16px;
    }

    /* page */
    html,body{height:100%}
    body{
      margin:0;
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 500px at 10% -10%, #eaf3ff 10%, transparent 60%),
        radial-gradient(1000px 500px at 120% 0%, #ecfeff 10%, transparent 60%),
        var(--bg);
    }
    .wrap{
      max-width: 1120px;
      margin: 48px auto;
      padding: 0 20px 80px;
    }

    /* header */
    .header{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      margin-bottom: 18px;
    }
    .brand{
      display:flex;align-items:center;gap:14px;
    }
    .logo{
      width:44px;height:44px;border-radius:12px;
      background: linear-gradient(135deg,var(--accent),var(--accent-2));
      display:grid;place-items:center;color:white;
      box-shadow: 0 6px 18px rgba(37,99,235,.22);
    }
    .logo svg{width:22px;height:22px;display:block}
    h1{
      margin:0;font-weight:800;letter-spacing:.2px;
      font-size: clamp(28px, 3.6vw, 44px);
    }
    .subtitle{
      color:var(--muted);margin:8px 0 24px;
      font-size:15px;
    }

    /* mode toggle */
    .tabs{
      display:flex;gap:10px;
      background:#eef5fb;border:1px solid var(--stroke);
      border-radius:999px;padding:6px;box-shadow: var(--shadow);
    }
    .tab{
      appearance:none;border:0;background:transparent;color:var(--muted);
      padding:10px 18px;border-radius:999px;font-weight:600;cursor:pointer;
    }
    .tab.active{background:white;color:var(--text);box-shadow:0 4px 12px rgba(16,24,40,.06)}
    .tab:focus-visible{outline:2px solid var(--accent-2);outline-offset:2px}

    /* card */
    .card{
      background:var(--card);border:1px solid var(--stroke);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;
    }
    .grid{
      display:grid;gap:14px;
      grid-template-columns: 1fr;
    }
    @media(min-width:960px){
      .grid{grid-template-columns: 1.2fr 1.1fr .9fr;}
    }

    label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:#6b7c8f;font-weight:700}
    .field{display:flex;flex-direction:column;gap:8px}

    input, select, textarea{
      width:100%;border:1px solid #dbe7f3;background:#fbfdff;color:var(--text);
      padding:12px 14px;border-radius:12px;font-size:16px;
      transition: box-shadow .15s, border-color .15s;
    }
    input:focus, select:focus, textarea:focus{outline:0;border-color:#b6cff1;box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    textarea{min-height:220px;resize:vertical}

    /* buttons */
    .actions{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-top:6px}
    .btn{
      appearance:none;border:0;border-radius:12px;cursor:pointer;
      font-weight:700;font-size:16px;padding:12px 18px;
      display:inline-flex;gap:10px;align-items:center;justify-content:center;
    }
    .btn svg{width:18px;height:18px}
    .primary{background:var(--accent);color:white;box-shadow:0 10px 20px rgba(37,99,235,.22)}
    .primary:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:#eef5fb;color:#0f2233;border:1px solid var(--stroke)}
    .success{background:var(--accent-3);color:#083b16}
    .mini{padding:8px 12px;font-size:14px}

    .note{display:flex;align-items:center;gap:8px;margin-top:10px;color:#556579}
    .chip{font-size:13px;padding:6px 10px;border-radius:999px;background:#f2f7ff;border:1px solid var(--stroke)}
    .status{min-height:24px;margin-left:12px;color:#183247}
    .linksRow{display:flex;align-items:center;gap:12px;margin-top:6px}
    .linksRow a{color:#0f6ad7;text-decoration:none}
    .linksRow a:hover{text-decoration:underline}

    /* bulk section */
    .bulkGrid{display:grid;gap:14px}
    @media(min-width:1000px){
      .bulkGrid{grid-template-columns: 1.2fr 1fr}
    }
    .hint{color:#6a7b8d;font-size:13px;margin:6px 0 0}

    /* footer space */
    .pad{height:40px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- map pin icon -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 21s-6-5.3-6-10a6 6 0 1 1 12 0c0 4.7-6 10-6 10z"/>
            <circle cx="12" cy="11" r="2.5" fill="currentColor" stroke="none"/>
          </svg>
        </div>
        <h1>MapBuddy — Asset → KML / GeoJSON / Shapefile</h1>
      </div>
      <div class="tabs" role="tablist" aria-label="Mode">
        <button class="tab active" id="tabSingle" role="tab" aria-selected="true">Single</button>
        <button class="tab" id="tabBulk" role="tab" aria-selected="false">Bulk</button>
      </div>
    </div>

    <p class="subtitle">
      Fast one-offs or bulk lists. Convert ArcGIS features to <strong>KML</strong>, <strong>GeoJSON</strong>, or
      <strong>zipped Shapefile</strong>. Includes Google Maps link helper. MDOT SHA layers may require VPN.
    </p>

    <!-- Single card -->
    <section id="panelSingle" class="card" role="tabpanel" aria-labelledby="tabSingle">
      <div class="grid">
        <div class="field">
          <label for="asset">Asset / BMP ID</label>
          <input id="asset" placeholder="e.g., WP0399, 210049UT, LOD_12345" autocomplete="off" />
        </div>

        <div class="field">
          <label for="dataset">Dataset</label>
          <select id="dataset">
            <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
            <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
            <optgroup label="MDOT SHA — TMDL">
              <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
              <option value="mdsha_tmdl_ret">TMDL — Retrofits</option>
              <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
              <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
              <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
              <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
            </optgroup>
          </select>
        </div>

        <div class="field">
          <label for="format">Format</label>
          <select id="format">
            <option value="kml">KML</option>
            <option value="geojson">GeoJSON</option>
            <option value="shp">Shapefile (.zip)</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="btnDownload" class="btn primary">
          <!-- download icon -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3v12m0 0 4-4m-4 4-4-4M4 17v3h16v-3"/></svg>
          Download
        </button>

        <button id="btnCopy" class="btn ghost mini" disabled>
          <!-- link icon -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M10 13a5 5 0 0 1 0-7l1.2-1.2a5 5 0 1 1 7 7L17 12"/>
            <path d="M14 11a5 5 0 0 1 0 7L12.8 19.2a5 5 0 1 1-7-7L7 10"/>
          </svg>
          Copy link
        </button>

        <div class="linksRow" id="mapsRow" hidden>
          <a id="mapsLink" target="_blank" rel="noopener">Open in Google Maps</a>
          <span class="status" id="coords"></span>
        </div>
      </div>

      <div class="note">
        <span class="chip">Note</span>
        <span>MDOT SHA layers may require VPN. MapBuddy saves your last choices locally.</span>
      </div>
    </section>

    <div class="pad"></div>

    <!-- Bulk card -->
    <section id="panelBulk" class="card" role="tabpanel" aria-labelledby="tabBulk" hidden>
      <div class="bulkGrid">
        <div class="field">
          <label for="bulkText">Paste CSV rows <small style="text-transform:none;color:#7b8896">(header optional; columns: <code>assetId</code> or <code>assetId,dataset</code>)</small></label>
          <textarea id="bulkText" placeholder="0256DP&#10;WP0400&#10;210049UT,mdsha_tmdl_tree_plantings"></textarea>
          <p class="hint">Rows without a dataset will use the <em>Default dataset</em> dropdown (no auto-detect).</p>
        </div>

        <div class="field">
          <label for="bulkFile">Upload CSV file</label>
          <input id="bulkFile" type="file" accept=".csv,text/csv" />
          <div class="field" style="margin-top:12px">
            <label for="bulkDataset">Default dataset (applies to rows without a dataset)</label>
            <select id="bulkDataset">
              <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
              <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
              <optgroup label="MDOT SHA — TMDL">
                <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
                <option value="mdsha_tmdl_ret">TMDL — Retrofits</option>
                <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
                <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
                <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
                <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
              </optgroup>
            </select>
          </div>

          <div class="field" style="margin-top:12px">
            <label for="bulkFormat">Format</label>
            <select id="bulkFormat">
              <option value="kmlzip">KML (.zip)</option>
              <option value="geojsonzip">GeoJSON (.zip)</option>
              <option value="shp">Shapefile (.zip)</option>
            </select>
          </div>

          <div class="actions" style="margin-top:14px">
            <button id="btnBulk" class="btn primary">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3v12m0 0 4-4m-4 4-4-4M4 17v3h16v-3"/></svg>
              Download
            </button>
            <span class="status" id="bulkStatus"></span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---- small helpers -------------------------------------------------------
    const $ = (sel) => document.querySelector(sel);
    const btnCopy = $('#btnCopy');
    const mapsRow = $('#mapsRow');
    const mapsLinkEl = $('#mapsLink');
    const coordsEl = $('#coords');

    // persist last choices
    const save = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const load = (k,d)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? d;}catch{ return d; }};

    // tabs
    const tabSingle = $('#tabSingle'), tabBulk = $('#tabBulk');
    const panelSingle = $('#panelSingle'), panelBulk = $('#panelBulk');
    function setTab(which){
      const single = which === 'single';
      tabSingle.classList.toggle('active', single);
      tabBulk.classList.toggle('active', !single);
      panelSingle.hidden = !single;
      panelBulk.hidden = single;
      save('ui_tab', which);
    }
    tabSingle.onclick = () => setTab('single');
    tabBulk.onclick   = () => setTab('bulk');
    setTab(load('ui_tab','single'));

    // restore dropdowns
    const datasetEl = $('#dataset'), formatEl = $('#format');
    const bulkDatasetEl = $('#bulkDataset'), bulkFormatEl = $('#bulkFormat');
    datasetEl.value = load('ds', datasetEl.value);
    formatEl.value  = load('fmt', formatEl.value);
    bulkDatasetEl.value = load('b_ds', bulkDatasetEl.value);
    bulkFormatEl.value  = load('b_fmt', bulkFormatEl.value);
    datasetEl.onchange = ()=>save('ds', datasetEl.value);
    formatEl.onchange  = ()=>save('fmt', formatEl.value);
    bulkDatasetEl.onchange = ()=>save('b_ds', bulkDatasetEl.value);
    bulkFormatEl.onchange  = ()=>save('b_fmt', bulkFormatEl.value);

    // ---- API wrappers --------------------------------------------------------
    async function locate(assetId, dataset){
      const r = await fetch('/api/locate', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ assetId, dataset })
      });
      if(!r.ok){
        let msg = `Locate failed (HTTP ${r.status})`;
        try{ const j = await r.json(); if(j?.error) msg = j.error; } catch {}
        throw new Error(msg);
      }
      return r.json();
    }

    async function convertSingle({assetId, dataset, format}){
      const r = await fetch('/api/convert',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ assetId, dataset, format })
      });
      if(!r.ok){
        let msg = `Request failed (HTTP ${r.status})`;
        try{ const j = await r.json(); if(j?.error) msg = j.error; } catch {}
        throw new Error(msg);
      }
      return r.blob();
    }

    async function convertBulk({items, defaultDataset, format}){
      const r = await fetch('/api/bulk',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ items, defaultDataset, format })
      });
      if(!r.ok){
        let msg = `Request failed (HTTP ${r.status})`;
        try{ const j = await r.json(); if(j?.error) msg = j.error; } catch {}
        throw new Error(msg);
      }
      return r.blob();
    }

    // ---- Single: locate + download + copy link ------------------------------
    const assetEl = $('#asset');
    const btnDownload = $('#btnDownload');

    async function doSingle(){
      const assetId = assetEl.value.trim();
      const dataset = datasetEl.value;
      const format  = formatEl.value;
      if(!assetId) return;

      btnDownload.disabled = true;
      btnCopy.disabled = true;
      mapsRow.hidden = true;

      try{
        // 1) locate for maps
        const info = await locate(assetId, dataset);
        if(info?.googleMapsUrl){
          mapsLinkEl.href = info.googleMapsUrl;
          mapsRow.hidden = false;
          btnCopy.disabled = false;
          if(info?.centroid){
            const {lat,lng} = info.centroid;
            coordsEl.textContent = `lat ${(+lat).toFixed(6)}, lng ${(+lng).toFixed(6)}`;
          } else {
            coordsEl.textContent = '';
          }
        }

        // 2) download file
        const blob = await convertSingle({assetId, dataset, format});
        const ext = format === 'kml' ? 'kml' : (format === 'geojson' ? 'geojson' : 'zip');
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), {href:url, download: `${assetId}.${ext}`});
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }catch(e){
        alert(e.message || 'Conversion failed');
      }finally{
        btnDownload.disabled = false;
      }
    }
    btnDownload.onclick = doSingle;
    assetEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSingle(); });

    btnCopy.onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(mapsLinkEl.href);
        btnCopy.textContent = 'Copied!';
        setTimeout(()=>btnCopy.textContent='Copy link',1200);
      }catch{
        // ignore
      }
    };

    // ---- Bulk: CSV parse + upload + download --------------------------------
    const bulkText = $('#bulkText');
    const bulkFile = $('#bulkFile');
    const bulkStatus = $('#bulkStatus');
    const btnBulk = $('#btnBulk');

    bulkFile.onchange = async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const text = await f.text();
      bulkText.value = text;
    };

    function parseRows(text){
      // Accept: assetId   OR   assetId,dataset
      return text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(l=>{
        const parts = l.split(',').map(s=>s.trim()).filter(Boolean);
        return parts.length>1 ? {assetId:parts[0], dataset:parts[1]} : {assetId:parts[0]};
      });
    }

    btnBulk.onclick = async ()=>{
      const items = parseRows(bulkText.value);
      if(items.length===0){ bulkStatus.textContent='Paste or upload some IDs first.'; return; }
      bulkStatus.textContent='Preparing…';
      btnBulk.disabled = true;
      try{
        const blob = await convertBulk({
          items,
          defaultDataset: bulkDatasetEl.value,
          format: bulkFormatEl.value
        });
        const url = URL.createObjectURL(blob);
        const name = (bulkFormatEl.value==='kmlzip' ? 'mapbuddy_kml.zip'
                      : bulkFormatEl.value==='geojsonzip' ? 'mapbuddy_geojson.zip'
                      : 'mapbuddy_shapefile.zip');
        const a = Object.assign(document.createElement('a'), {href:url, download: name});
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        bulkStatus.textContent='Done.';
      }catch(e){
        bulkStatus.textContent = e.message || 'Bulk conversion failed.';
      }finally{
        btnBulk.disabled = false;
      }
    };

    // auto-save the CSV text between visits
    bulkText.value = load('bulk_text','');
    bulkText.oninput = ()=>save('bulk_text', bulkText.value);
  </script>
</body>
</html>
