<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MapBuddy — Asset → KML / GeoJSON / Shapefile</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mbBlue:  '#2563eb',
            mbGreen: '#059669',
            mbSlate: '#0f172a'
          },
          boxShadow: {
            card: '0 10px 30px rgba(2,6,23,.06)'
          }
        }
      }
    }
  </script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%232563eb' d='M6 10a4 4 0 0 1 4-4h4l8 3l8-3h4a4 4 0 0 1 4 4v24a4 4 0 0 1-4 4h-4l-8-3l-8 3h-4a4 4 0 0 1-4-4z'/%3E%3Cpath fill='%23059669' d='M14 6v32l8-3V3zM34 6v32l-8-3V3z'/%3E%3C/svg%3E" />
  <style>
    .pill { @apply inline-flex items-center gap-2 rounded-full border px-3 py-1 text-sm; }
    .btn  { @apply inline-flex items-center justify-center rounded-xl px-5 py-3 font-semibold transition; }
    .btn-primary { @apply bg-mbBlue text-white hover:bg-blue-600; }
    .btn-ghost   { @apply bg-white text-mbBlue border border-blue-200 hover:border-blue-300; }
    .btn-green   { @apply bg-mbGreen text-white hover:bg-emerald-600; }
    .kbd { @apply px-2 py-0.5 rounded border text-xs text-slate-600 bg-slate-50; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-lg bg-gradient-to-r from-mbBlue to-mbGreen grid place-items-center shadow-sm">
            <svg width="18" height="18" viewBox="0 0 24 24" class="text-white">
              <path fill="currentColor" d="M9 20l-5.447-2.724A1 1 0 0 1 3 16.382V5.618a1 1 0 0 1 1.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0 0 21 18.382V7.618a1 1 0 0 0-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
          </div>
          <span class="font-bold text-xl text-slate-900">MapBuddy</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="px-4">
    <div class="max-w-6xl mx-auto pt-10 pb-4">
      <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 leading-tight">
        Convert Assets to <span class="bg-clip-text text-transparent bg-gradient-to-r from-mbBlue to-mbGreen">Map Files</span>
      </h1>
      <p class="mt-4 text-lg text-slate-600 max-w-3xl">
        Fast one-offs or bulk lists. Generate <strong>KML</strong>, <strong>GeoJSON</strong>, or zipped <strong>Shapefile</strong> from ArcGIS features.
        Bulk downloads include a <code class="kbd">mapbuddy_links.csv</code> with Google Maps links.
      </p>
    </div>
  </section>

  <!-- Mode toggle -->
  <section class="px-4">
    <div class="max-w-6xl mx-auto">
      <div class="flex justify-center">
        <div class="bg-white shadow-card rounded-2xl p-1 flex gap-1">
          <button id="tabSingle" class="btn px-6 py-2 rounded-xl bg-slate-100 text-slate-900">Single</button>
          <button id="tabBulk"   class="btn px-6 py-2 rounded-xl text-slate-600 hover:text-slate-900">Bulk</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Single -->
  <section id="singlePane" class="px-4 mt-8">
    <div class="max-w-6xl mx-auto">
      <div class="bg-white shadow-card rounded-2xl p-6 md:p-8">
        <div class="grid md:grid-cols-3 gap-5">
          <div class="space-y-3">
            <label class="block text-sm font-medium text-slate-700">Asset / BMP ID</label>
            <input id="singleAsset" placeholder="e.g., WP0399, 210049UT, LOD_12345" class="w-full rounded-xl border p-3 focus:outline-none focus:ring-2 focus:ring-mbBlue" />
          </div>

          <div class="space-y-3">
            <label class="block text-sm font-medium text-slate-700">Dataset</label>
            <select id="singleDataset" class="w-full rounded-xl border p-3 bg-white focus:outline-none focus:ring-2 focus:ring-mbBlue">
              <optgroup label="Fairfax">
                <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
              </optgroup>
              <optgroup label="MDOT SHA">
                <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
              </optgroup>
              <optgroup label="MDOT SHA — TMDL">
                <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
                <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
                <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
                <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
                <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
                <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
              </optgroup>
            </select>
          </div>

          <div class="space-y-3">
            <label class="block text-sm font-medium text-slate-700">Format</label>
            <select id="singleFormat" class="w-full rounded-xl border p-3 bg-white focus:outline-none focus:ring-2 focus:ring-mbBlue">
              <option value="kml">KML</option>
              <option value="geojson">GeoJSON</option>
              <option value="shapefile">Shapefile (.zip)</option>
            </select>
          </div>
        </div>

        <div class="mt-5 flex flex-wrap items-center gap-3">
          <button id="singleGo" class="btn btn-primary">Download</button>

          <div id="linkRow" class="hidden items-center gap-3">
            <a id="mapsLink" target="_blank" class="pill border-blue-200 text-mbBlue hover:bg-blue-50">Open in Google Maps →</a>
            <button id="copyLink" class="pill bg-slate-50 hover:bg-slate-100 border-slate-200 text-slate-700">Copy link</button>
          </div>

          <span id="singleNote" class="ml-auto text-sm text-slate-500">
            <span class="px-2 py-0.5 rounded-full bg-slate-100 border text-slate-700">Note</span>
            MDOT SHA layers may require VPN.
          </span>
        </div>

        <p id="singleStatus" class="mt-3 text-sm text-slate-600"></p>
      </div>
    </div>
  </section>

  <!-- Bulk -->
  <section id="bulkPane" class="px-4 mt-8 hidden">
    <div class="max-w-6xl mx-auto">
      <div class="bg-white shadow-card rounded-2xl p-6 md:p-8">
        <div class="grid lg:grid-cols-3 gap-6">
          <!-- Left: CSV -->
          <div class="lg:col-span-2 space-y-4">
            <div class="flex items-center justify-between">
              <div class="space-y-2">
                <label class="block text-sm font-medium text-slate-700">Paste CSV rows</label>
                <p class="text-xs text-slate-500">Header optional · columns: <code class="kbd">assetId</code> or <code class="kbd">assetId,dataset</code></p>
              </div>
              <input id="bulkFile" type="file" accept=".csv" class="hidden" />
              <button id="bulkFileBtn" class="btn btn-ghost">Upload CSV file</button>
            </div>
            <textarea id="bulkText" rows="10" class="w-full rounded-xl border p-3 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-mbBlue" placeholder="WP0399&#10;WP0400, fairfax_bmps&#10;210049UT, mdsha_tmdl_tree_plantings"></textarea>

            <div class="text-xs text-slate-500">
              Rows without a dataset use the selection at right. (No auto-detect.)
            </div>
          </div>

          <!-- Right: Options -->
          <div class="space-y-4">
            <div class="space-y-2">
              <label class="block text-sm font-medium text-slate-700">Default dataset (applies if row lacks a dataset)</label>
              <select id="bulkDataset" class="w-full rounded-xl border p-3 bg-white focus:outline-none focus:ring-2 focus:ring-mbBlue">
                <optgroup label="Fairfax">
                  <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
                </optgroup>
                <optgroup label="MDOT SHA">
                  <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
                </optgroup>
                <optgroup label="MDOT SHA — TMDL">
                  <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
                  <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
                  <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
                  <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
                  <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
                  <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
                </optgroup>
              </select>
            </div>

            <div class="space-y-2">
              <label class="block text-sm font-medium text-slate-700">Format</label>
              <select id="bulkFormat" class="w-full rounded-xl border p-3 bg-white focus:outline-none focus:ring-2 focus:ring-mbBlue">
                <option value="kmlzip">KML (.zip)</option>
                <option value="geojsonzip">GeoJSON (.zip)</option>
                <option value="shpzip">Shapefile (.zip)</option>
              </select>
            </div>

            <button id="bulkGo" class="btn btn-green w-full">Download</button>

            <div class="text-xs text-slate-500">
              Bulk zips also include <code class="kbd">mapbuddy_links.csv</code> with Google Maps links.
            </div>
          </div>
        </div>

        <p id="bulkStatus" class="mt-4 text-sm text-slate-600"></p>
      </div>
    </div>
  </section>

  <footer class="py-10 text-center text-slate-400 text-sm">
    © 2024 MapBuddy · Simple, reliable asset-to-map conversion.
  </footer>

  <script>
    // --- Elements
    const tabSingle = document.getElementById('tabSingle');
    const tabBulk   = document.getElementById('tabBulk');
    const singlePane= document.getElementById('singlePane');
    const bulkPane  = document.getElementById('bulkPane');

    const singleAsset   = document.getElementById('singleAsset');
    const singleDataset = document.getElementById('singleDataset');
    const singleFormat  = document.getElementById('singleFormat');
    const singleGo      = document.getElementById('singleGo');
    const singleStatus  = document.getElementById('singleStatus');
    const mapsLink      = document.getElementById('mapsLink');
    const copyLinkBtn   = document.getElementById('copyLink');
    const linkRow       = document.getElementById('linkRow');

    const bulkText     = document.getElementById('bulkText');
    const bulkFile     = document.getElementById('bulkFile');
    const bulkFileBtn  = document.getElementById('bulkFileBtn');
    const bulkDataset  = document.getElementById('bulkDataset');
    const bulkFormat   = document.getElementById('bulkFormat');
    const bulkGo       = document.getElementById('bulkGo');
    const bulkStatus   = document.getElementById('bulkStatus');

    // --- Helpers
    function setTab(isSingle) {
      if (isSingle) {
        tabSingle.classList.add('bg-slate-100','text-slate-900');
        tabBulk.classList.remove('bg-slate-100','text-slate-900');
        singlePane.classList.remove('hidden');
        bulkPane.classList.add('hidden');
      } else {
        tabBulk.classList.add('bg-slate-100','text-slate-900');
        tabSingle.classList.remove('bg-slate-100','text-slate-900');
        bulkPane.classList.remove('hidden');
        singlePane.classList.add('hidden');
      }
    }
    tabSingle.onclick = () => setTab(true);
    tabBulk.onclick   = () => setTab(false);

    function downloadBlob(filename, blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Persist last choices
    function savePrefs() {
      localStorage.setItem('mb.dataset', singleDataset.value);
      localStorage.setItem('mb.format',  singleFormat.value);
      localStorage.setItem('mb.bulkDataset', bulkDataset.value);
      localStorage.setItem('mb.bulkFormat',  bulkFormat.value);
    }
    function loadPrefs() {
      const d = localStorage.getItem('mb.dataset');
      const f = localStorage.getItem('mb.format');
      const bd= localStorage.getItem('mb.bulkDataset');
      const bf= localStorage.getItem('mb.bulkFormat');
      if (d) singleDataset.value = d;
      if (f) singleFormat.value  = f;
      if (bd) bulkDataset.value  = bd;
      if (bf) bulkFormat.value   = bf;
    }
    loadPrefs();
    [singleDataset,singleFormat,bulkDataset,bulkFormat].forEach(el => el.addEventListener('change', savePrefs));

    // --- Single: locate->convert
    async function locate(assetId, dataset) {
      const r = await fetch('/api/locate', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ assetId, dataset })
      });
      if (!r.ok) throw new Error(`Locate failed (HTTP ${r.status})`);
      return r.json();
    }

    async function convert(assetId, dataset, format) {
      const r = await fetch('/api/convert', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ assetId, dataset, format })
      });
      if (!r.ok) {
        let msg = `Request failed (HTTP ${r.status})`;
        try { const err = await r.json(); if (err?.error) msg = err.error; } catch {}
        throw new Error(msg);
      }
      return r.blob();
    }

    singleGo.onclick = async () => {
      const asset   = singleAsset.value.trim();
      const dataset = singleDataset.value;
      const format  = singleFormat.value; // 'kml' | 'geojson' | 'shapefile'
      if (!asset) { singleStatus.textContent = 'Please enter an Asset / BMP ID.'; return; }

      singleGo.disabled = true;
      singleStatus.textContent = 'Locating…';
      linkRow.classList.add('hidden');

      try {
        const info = await locate(asset, dataset);
        if (info?.googleMapsUrl) {
          mapsLink.href = info.googleMapsUrl;
          linkRow.classList.remove('hidden');
          copyLinkBtn.onclick = async () => {
            try {
              await navigator.clipboard.writeText(info.googleMapsUrl);
              singleStatus.textContent = 'Copied Google Maps link.';
            } catch { singleStatus.textContent = 'Copy failed.'; }
          }
        }
        singleStatus.textContent = 'Converting…';
        const blob = await convert(asset, dataset, format);
        const ext  = (format === 'kml') ? 'kml' : (format === 'geojson') ? 'geojson' : 'zip';
        downloadBlob(`${asset}.${ext}`, blob);
        singleStatus.textContent = 'Done.';
      } catch (e) {
        singleStatus.textContent = e.message || 'Error';
      } finally {
        singleGo.disabled = false;
      }
    };

    // --- Bulk: CSV handling & POST /api/bulk
    bulkFileBtn.onclick = () => bulkFile.click();
    bulkFile.onchange = async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const text = await file.text();
      document.getElementById('bulkText').value = text.trim();
    };

    function parseCsvToItems(text, defaultDataset) {
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      if (lines.length === 0) return [];
      // Check for header by looking for non-ID words in first row
      const first = lines[0].split(',').map(s => s.trim());
      let start = 0;
      if (first[0].toLowerCase().includes('asset')) start = 1;

      const items = [];
      for (let i=start; i<lines.length; i++) {
        const cols = lines[i].split(',').map(s => s.trim()).filter(c => c.length);
        if (!cols.length) continue;
        const assetId = cols[0];
        const dataset = (cols[1] && cols[1] !== '-') ? cols[1] : defaultDataset;
        if (assetId) items.push({ assetId, dataset });
      }
      return items;
    }

    async function bulkConvert(payload) {
      const r = await fetch('/api/bulk', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!r.ok) {
        let msg = `Bulk failed (HTTP ${r.status})`;
        try { const err = await r.json(); if (err?.error) msg = err.error; } catch {}
        throw new Error(msg);
      }
      return r.blob();
    }

    bulkGo.onclick = async () => {
      const text = bulkText.value.trim();
      if (!text) { bulkStatus.textContent = 'Paste or upload a CSV first.'; return; }
      const defaultDataset = bulkDataset.value;
      const fmt = bulkFormat.value; // 'kmlzip'|'geojsonzip'|'shpzip'

      const items = parseCsvToItems(text, defaultDataset);
      if (items.length === 0) { bulkStatus.textContent = 'No parsable rows found.'; return; }

      bulkGo.disabled = true;
      bulkStatus.textContent = `Processing ${items.length} item(s)…`;
      try {
        const blob = await bulkConvert({
          items,
          defaultDataset,
          format: fmt
        });
        const name = (fmt === 'kmlzip') ? 'mapbuddy_kml.zip'
                   : (fmt === 'geojsonzip') ? 'mapbuddy_geojson.zip'
                   : 'mapbuddy_shapefile.zip';
        downloadBlob(name, blob);
        bulkStatus.textContent = 'Done.';
      } catch (e) {
        bulkStatus.textContent = e.message || 'Error';
      } finally {
        bulkGo.disabled = false;
      }
    };

    // Start on Single
    setTab(true);
  </script>
</body>
</html>
