<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MapBuddy — Asset → KML / GeoJSON / Shapefile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mbBlue:  "#2563eb",
            mbGreen: "#059669"
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gradient-to-b from-slate-50 to-blue-50 text-slate-900">

  <!-- Header -->
  <header class="w-full">
    <div class="max-w-6xl mx-auto px-4 sm:px-6">
      <div class="flex items-center gap-3 py-5">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-r from-mbBlue to-mbGreen flex items-center justify-center text-white font-bold">M</div>
        <div class="text-lg font-semibold">MapBuddy</div>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-6xl mx-auto px-4 sm:px-6">
    <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">
      Convert Assets to
      <span class="text-transparent bg-clip-text bg-gradient-to-r from-mbBlue to-mbGreen">Map Files</span>
    </h1>
    <p class="mt-4 text-lg text-slate-600 max-w-3xl">
      Transform asset numbers into KML, GeoJSON, Shapefile. Single asset or bulk processing available.
    </p>

    <!-- Mode Toggle -->
    <div class="mt-6 flex gap-3">
      <button id="btnSingle" class="inline-flex items-center px-4 py-2 rounded-full font-semibold text-white shadow transition bg-gradient-to-r from-mbBlue to-mbGreen">Single</button>
      <button id="btnBulk"   class="inline-flex items-center px-4 py-2 rounded-full font-semibold bg-white text-gray-700 border border-gray-200 shadow-sm transition">Bulk</button>
    </div>
  </section>

  <!-- Single -->
  <section id="singlePanel" class="max-w-6xl mx-auto px-4 sm:px-6 mt-6">
    <div class="bg-white shadow-xl rounded-2xl p-5 sm:p-6">
      <div class="grid lg:grid-cols-12 gap-4 items-end">
        <div class="lg:col-span-4">
          <label class="block text-sm font-medium mb-2">Asset / BMP ID</label>
          <input id="singleAsset" type="text"
                 placeholder="e.g., WP0399, 210049UT, LOD_12345"
                 class="w-full rounded-xl border-slate-200 focus:ring-mbBlue focus:border-mbBlue px-4 py-3" />
        </div>
        <div class="lg:col-span-5">
          <label class="block text-sm font-medium mb-2">Dataset</label>
          <select id="singleDataset"
                  class="w-full rounded-xl border-slate-200 focus:ring-mbBlue focus:border-mbBlue px-4 py-3">
            <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
            <option value="mdsha_tmdl_scs">TMDL — Stormwater Control Structures</option>
            <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
            <option value="mdsha_tmdl_trees">TMDL — Tree Plantings</option>
            <option value="mdsha_tmdl_pavement">TMDL — Pavement Removals</option>
            <option value="mdsha_tmdl_streams">TMDL — Stream Restorations</option>
            <option value="mdsha_tmdl_outfalls">TMDL — Outfall Stabilizations</option>
            <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
          </select>
        </div>
        <div class="lg:col-span-3">
          <label class="block text-sm font-medium mb-2">Format</label>
          <select id="singleFormat"
                  class="w-full rounded-xl border-slate-200 focus:ring-mbBlue focus:border-mbBlue px-4 py-3">
            <option value="kml">KML</option>
            <option value="geojson">GeoJSON</option>
            <option value="shapefile">Shapefile (.zip)</option>
          </select>
        </div>
      </div>

      <div class="mt-5 flex flex-wrap items-center gap-3">
        <!-- Gradient primary -->
        <button id="btnDownloadSingle"
                class="rounded-xl text-white font-semibold px-5 py-3 transition shadow-md bg-gradient-to-r from-mbBlue to-mbGreen">
          Download
        </button>

        <!-- Hidden until generated -->
        <a id="linkGmaps" href="#" target="_blank"
           class="hidden rounded-xl bg-white text-mbBlue font-semibold px-5 py-3 shadow border border-blue-100">
          Open in Google Maps →
        </a>

        <!-- Hidden until generated -->
        <button id="btnCopyLink"
                class="hidden rounded-xl text-white font-semibold px-5 py-3 transition shadow-md bg-gradient-to-r from-mbBlue to-mbGreen">
          Copy link
        </button>


        <span class="ml-auto inline-flex items-center gap-2 text-sm px-3 py-1 rounded-full bg-gray-100 text-gray-700">
          <span class="font-semibold">Note</span> MDOT SHA layers may require VPN.
        </span>
      </div>
    </div>
  </section>

  <!-- Bulk -->
  <section id="bulkPanel" class="max-w-6xl mx-auto px-4 sm:px-6 mt-6 hidden">
    <div class="bg-white shadow-xl rounded-2xl p-5 sm:p-6">
      <h2 class="text-xl font-bold mb-4">Bulk Asset Conversion</h2>

      <div class="grid lg:grid-cols-12 gap-6">
        <!-- Left -->
        <div class="lg:col-span-6 space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Dataset</label>
            <select id="bulkDataset"
                    class="w-full rounded-xl border-slate-200 focus:ring-mbBlue focus:border-mbBlue px-4 py-3">
              <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
              <option value="mdsha_tmdl_scs">TMDL — Stormwater Control Structures</option>
              <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
              <option value="mdsha_tmdl_trees">TMDL — Tree Plantings</option>
              <option value="mdsha_tmdl_pavement">TMDL — Pavement Removals</option>
              <option value="mdsha_tmdl_streams">TMDL — Stream Restorations</option>
              <option value="mdsha_tmdl_outfalls">TMDL — Outfall Stabilizations</option>
              <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
            </select>
          </div>

          <!-- CSV drop -->
          <div id="dropArea"
               class="border-2 border-dashed border-blue-200 rounded-2xl p-8 text-center hover:border-mbBlue transition-colors">
            <div class="mx-auto w-14 h-14 rounded-full bg-gradient-to-r from-mbBlue to-mbGreen text-white flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6h.1a5 5 0 011 9.9M15 13l-3-3-3 3m3-3v12"/>
              </svg>
            </div>
            <h4 class="mt-3 text-lg font-semibold">Drop your CSV file here</h4>
            <p class="text-slate-500">or click to browse</p>
            <input id="bulkFile" type="file" accept=".csv" class="hidden" />
            <div class="mt-4">
              <button id="btnChooseCsv" class="rounded-xl bg-white text-mbBlue font-semibold px-5 py-3 shadow border border-blue-100">Choose CSV File</button>
              <span id="csvStatus" class="ml-3 text-slate-500"></span>
            </div>
          </div>

          <div class="bg-blue-50 border border-blue-100 rounded-xl p-4">
            <h5 class="font-semibold text-blue-900 mb-2">CSV Format Requirements:</h5>
            <ul class="text-sm text-blue-800 space-y-1">
              <li>• First column: Asset numbers</li>
              <li>• Header row optional</li>
              <li>• Up to 1000 assets per file</li>
              <li>• Optional second column: dataset key</li>
            </ul>
          </div>
        </div>

        <!-- Right -->
        <div class="lg:col-span-6 space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Output Format</label>
            <select id="bulkFormat"
                    class="w-full rounded-xl border-slate-200 focus:ring-mbBlue focus:border-mbBlue px-4 py-3">
              <option value="kmlzip">KML (.zip)</option>
              <option value="geojsonzip">GeoJSON (.zip)</option>
              <option value="shapefile">Shapefile (.zip)</option>
            </select>
          </div>

          <div class="pt-2">
            <button id="btnProcessBulk" class="w-full rounded-xl text-white font-semibold px-5 py-3 transition shadow-md bg-gradient-to-r from-mbBlue to-mbGreen">
              Process Bulk Conversion
            </button>
            <div id="bulkStatus" class="mt-2 text-slate-500"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="max-w-6xl mx-auto px-4 sm:px-6 mt-10 mb-10 text-center text-slate-500">
    © 2025 MapBuddy · Simple, reliable asset-to-map conversion.
  </footer>

  <script>
    // utilities
    const $ = (s) => document.querySelector(s);

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    async function getGoogleMapsUrl(assetId, datasetKey) {
      try {
        const res = await fetch(`/api/gmaps?assetId=${encodeURIComponent(assetId)}&dataset=${encodeURIComponent(datasetKey)}`);
        if (!res.ok) throw 0;
        const data = await res.json();
        return data.url || "#";
      } catch { return "#"; }
    }

    // elements
    const btnSingle = $("#btnSingle");
    const btnBulk   = $("#btnBulk");
    const singlePanel = $("#singlePanel");
    const bulkPanel   = $("#bulkPanel");

    // single
    const singleAsset   = $("#singleAsset");
    const singleDataset = $("#singleDataset");
    const singleFormat  = $("#singleFormat");
    const btnDownloadSingle = $("#btnDownloadSingle");
    const linkGmaps = $("#linkGmaps");
    const btnCopyLink = $("#btnCopyLink");
    const singleStatus = $("#singleStatus");

    // bulk
    const bulkDataset = $("#bulkDataset");
    const bulkFormat  = $("#bulkFormat");
    const dropArea    = $("#dropArea");
    const bulkFile    = $("#bulkFile");
    const btnChooseCsv= $("#btnChooseCsv");
    const btnProcessBulk = $("#btnProcessBulk");
    const csvStatus   = $("#csvStatus");
    const bulkStatus  = $("#bulkStatus");

    // mode toggle (no custom CSS)
    const pillActive = "inline-flex items-center px-4 py-2 rounded-full font-semibold text-white shadow transition bg-gradient-to-r from-mbBlue to-mbGreen";
    const pillIdle   = "inline-flex items-center px-4 py-2 rounded-full font-semibold bg-white text-gray-700 border border-gray-200 shadow-sm transition";

    function setMode(mode) {
      if (mode === "single") {
        singlePanel.classList.remove("hidden");
        bulkPanel.classList.add("hidden");
        btnSingle.className = pillActive;
        btnBulk.className   = pillIdle;
      } else {
        singlePanel.classList.add("hidden");
        bulkPanel.classList.remove("hidden");
        btnSingle.className = pillIdle;
        btnBulk.className   = pillActive;
      }
    }
    btnSingle.addEventListener("click", () => setMode("single"));
    btnBulk.addEventListener("click",   () => setMode("bulk"));
    setMode("single");

    // SINGLE logic
    let singleGenerated = false;
    let currentGmapsUrl = "#";

    function hideMapActions() {
      singleGenerated = false;
      currentGmapsUrl = "#";
      linkGmaps.classList.add("hidden");
      btnCopyLink.classList.add("hidden");
    }
    singleAsset.addEventListener("input", hideMapActions);
    singleDataset.addEventListener("change", hideMapActions);
    singleFormat.addEventListener("change", hideMapActions);

    btnDownloadSingle.addEventListener("click", async () => {
      const assetId = singleAsset.value.trim();
      if (!assetId) { singleStatus.textContent = "Enter an asset ID."; return; }

      const dataset = singleDataset.value;
      const format  = singleFormat.value;

      singleStatus.textContent = "Downloading…";
      btnDownloadSingle.disabled = true;

      try {
        const res = await fetch("/api/convert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ assetId, dataset, format })
        });
        if (!res.ok) throw new Error(await res.text() || "Request failed.");
        const blob = await res.blob();

        const cd = res.headers.get("content-disposition") || "";
        const m  = /filename="?([^"]+)"?/i.exec(cd);
        const fallback =
          format === "geojson"  ? "mapbuddy.geojson" :
          format === "shapefile"? "mapbuddy_shapefile.zip" : "mapbuddy.kml";
        downloadBlob(blob, m ? m[1] : fallback);

        // show map link now
        singleGenerated = true;
        currentGmapsUrl = await getGoogleMapsUrl(assetId, dataset);
        if (currentGmapsUrl && currentGmapsUrl !== "#") {
          linkGmaps.href = currentGmapsUrl;
          linkGmaps.classList.remove("hidden");
          btnCopyLink.classList.remove("hidden");
        }
        singleStatus.textContent = "Done.";
      } catch (err) {
        singleStatus.textContent = "Error: " + err.message;
      } finally {
        btnDownloadSingle.disabled = false;
      }
    });

    btnCopyLink.addEventListener("click", async () => {
      if (!singleGenerated || !currentGmapsUrl || currentGmapsUrl === "#") return;
      try {
        await navigator.clipboard.writeText(currentGmapsUrl);
        btnCopyLink.textContent = "Copied!";
        setTimeout(() => (btnCopyLink.textContent = "Copy link"), 1200);
      } catch {}
    });

    // BULK logic
    let bulkCsvText = "";
    btnChooseCsv.addEventListener("click", () => bulkFile.click());

    dropArea.addEventListener("click", () => bulkFile.click());
    dropArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropArea.classList.add("border-mbBlue");
    });
    dropArea.addEventListener("dragleave", () => dropArea.classList.remove("border-mbBlue"));
    dropArea.addEventListener("drop", (e) => {
      e.preventDefault();
      dropArea.classList.remove("border-mbBlue");
      if (e.dataTransfer.files?.[0]) handleCsvFile(e.dataTransfer.files[0]);
    });
    bulkFile.addEventListener("change", () => {
      if (bulkFile.files?.[0]) handleCsvFile(bulkFile.files[0]);
    });

    function handleCsvFile(file) {
      if (!/\.csv$/i.test(file.name)) { csvStatus.textContent = "Please choose a .csv file."; return; }
      const reader = new FileReader();
      reader.onload = () => { bulkCsvText = String(reader.result || ""); csvStatus.textContent = file.name + " • loaded"; };
      reader.readAsText(file);
    }

    function parseCsvToItems(csvText) {
      const lines = csvText.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (!lines.length) return [];
      const rows = lines.map(l => l.split(",").map(s => s.trim()));
      const startIdx = (rows[0][0] || "").toLowerCase().includes("asset") ? 1 : 0;
      const items = [];
      for (let i=startIdx;i<rows.length;i++){
        const [assetId, datasetMaybe] = rows[i];
        if (!assetId) continue;
        const rec = { assetId };
        if (datasetMaybe) rec.dataset = datasetMaybe;
        items.push(rec);
      }
      return items;
    }

    btnProcessBulk.addEventListener("click", async () => {
      if (!bulkCsvText) { bulkStatus.textContent = "Please choose a CSV file."; return; }
      const items = parseCsvToItems(bulkCsvText);
      if (!items.length) { bulkStatus.textContent = "No valid rows found in CSV."; return; }

      const payload = {
        items,
        defaultDataset: bulkDataset.value,
        format: bulkFormat.value
      };

      bulkStatus.textContent = "Processing…";
      btnProcessBulk.disabled = true;

      try {
        const res = await fetch("/api/bulk", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text() || "Bulk request failed.");
        const blob = await res.blob();

        const cd = res.headers.get("content-disposition") || "";
        const m  = /filename="?([^"]+)"?/i.exec(cd);
        const fallback =
          payload.format === "geojsonzip" ? "mapbuddy_geojson.zip" :
          payload.format === "shapefile"  ? "mapbuddy_shapefile.zip" :
                                           "mapbuddy_kml.zip";
        downloadBlob(blob, m ? m[1] : fallback);
        bulkStatus.textContent = "Done.";
      } catch (err) {
        bulkStatus.textContent = "Error: " + err.message;
      } finally {
        btnProcessBulk.disabled = false;
      }
    });
  </script>
</body>
</html>
