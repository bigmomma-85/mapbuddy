<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MapBuddy — Asset → KML / GeoJSON / Shapefile</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --border:#e9ecf2; --text:#222; --muted:#667; --brand:#0b72ff; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); margin:0; padding:28px; color:var(--text);}
    .card{max-width: 1000px; margin:0 auto; background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.04); padding:24px;}
    h1{margin:0 0 10px; font-size:28px;}
    p{margin:0 0 16px; color:#445;}
    label{display:block; font-size:14px; color:#334; margin:12px 0 6px;}
    input,select,textarea,button{width:100%; padding:12px; font-size:16px; border:1px solid #cfd6e4; border-radius:8px; background:#fff}
    textarea{min-height:170px; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .row{display:grid; gap:12px;}
    .two{grid-template-columns: 1fr 1fr;}
    .three{grid-template-columns: 2fr 1fr 1fr;}
    button{background:var(--brand); color:#fff; border:none; cursor:pointer;}
    button:disabled{background:#8fb6ff; cursor:not-allowed;}
    .tabs{display:flex; gap:10px; margin:6px 0 10px;}
    .tab{padding:8px 14px; border:1px solid #cfd6e4; border-radius:999px; background:#fff; cursor:pointer;}
    .tab.active{background:#0b72ff; border-color:#0b72ff; color:#fff;}
    .muted{color:var(--muted); font-size:14px;}
    .ok{color:#0a7f23; font-weight:600;}
    .drop{border:2px dashed #cfd6e4; border-radius:8px; height:72px; display:flex; align-items:center; justify-content:center; color:#556; background:#fafbff}
    .stack{display:grid; gap:10px;}
  </style>
</head>
<body>
  <div class="card">
    <h1>MapBuddy — Asset → KML / GeoJSON / Shapefile</h1>
    <p>Fast one-offs or bulk lists. Converts ArcGIS features to KML, GeoJSON or zipped Shapefile via Mapshaper.</p>

    <div class="tabs">
      <button id="tabSingle" class="tab active">Single</button>
      <button id="tabBulk" class="tab">Bulk</button>
    </div>

    <!-- Single -->
    <div id="singlePane" class="stack">
      <div class="row two">
        <div>
          <label>Asset / BMP ID</label>
          <input id="singleAsset" placeholder="e.g., WP0399, 210049UT, LOD_12345"/>
        </div>
        <div>
          <label>Dataset</label>
          <select id="singleDataset">
            <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
            <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
            <optgroup label="MDOT SHA — TMDL">
              <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
              <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
              <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
              <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
              <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
              <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
            </optgroup>
          </select>
        </div>
      </div>

      <div class="row two">
        <div>
          <label>Format</label>
          <select id="singleFormat">
            <option value="kml">KML</option>
            <option value="geojson">GeoJSON</option>
            <option value="shapefile">Shapefile (.zip)</option>
          </select>
          <div class="muted" style="margin-top:8px;">Note: MDOT SHA layers may require VPN.</div>
        </div>
        <div style="align-self:end;">
          <button id="singleGo">Download</button>
        </div>
      </div>

      <div id="singleStatus" class="muted"></div>
    </div>

    <!-- Bulk -->
    <div id="bulkPane" class="stack" style="display:none">
      <div class="row">
        <div>
          <label>Paste CSV rows <span class="muted">(header optional; columns: <code>assetId</code> or <code>assetId,dataset</code>)</span></label>
          <textarea id="bulkText" placeholder="WP0399
WP0400
210049UT,mdsha_tmdl_tree_plantings"></textarea>
        </div>
      </div>

      <div class="row three">
        <div>
          <label>Upload CSV file</label>
          <div id="drop" class="drop">Drop CSV here or click to choose</div>
          <input id="file" type="file" accept=".csv" style="display:none"/>
        </div>
        <div>
          <label>Default dataset (applies to rows without a dataset)</label>
          <select id="bulkDefaultDataset">
            <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
            <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
            <optgroup label="MDOT SHA — TMDL">
              <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
              <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
              <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
              <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
              <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
              <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
            </optgroup>
          </select>
        </div>
        <div>
          <label>Format</label>
          <select id="bulkFormat">
            <option value="kml">KML (.zip)</option>
            <option value="geojson">GeoJSON (.zip)</option>
            <option value="shapefile">Shapefile (.zip)</option>
          </select>
        </div>
      </div>

      <div class="row two">
        <div class="muted">Rows that <em>do not</em> include a dataset will use the <b>Default dataset</b> dropdown (no auto-detect).</div>
        <div style="text-align:right"><button id="bulkGo">Download</button></div>
      </div>

      <div id="bulkStatus" class="muted"></div>
    </div>
  </div>

<script>
  // -------- tabs
  const tabSingle = document.getElementById('tabSingle');
  const tabBulk = document.getElementById('tabBulk');
  const singlePane = document.getElementById('singlePane');
  const bulkPane = document.getElementById('bulkPane');

  function show(which){
    if (which === 'single'){ singlePane.style.display='grid'; bulkPane.style.display='none'; tabSingle.classList.add('active'); tabBulk.classList.remove('active'); }
    else { singlePane.style.display='none'; bulkPane.style.display='grid'; tabBulk.classList.add('active'); tabSingle.classList.remove('active'); }
  }
  tabSingle.onclick = () => show('single');
  tabBulk.onclick = () => show('bulk');

  // -------- helpers
  async function downloadBlob(url, method, body, fallbackName='download.bin') {
    const r = await fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if (!r.ok) {
      let msg = `HTTP ${r.status}`;
      try { const e = await r.json(); if (e?.error) msg = e.error; } catch {}
      throw new Error(msg);
    }
    const blob = await r.blob();
    const cd = r.headers.get('Content-Disposition') || '';
    const m = cd.match(/filename="?([^"]+)"?/i);
    const fname = m ? m[1] : fallbackName;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fname;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(a.href);
  }

  function parseCsvText(text){
    const rows = [];
    text.split(/\r?\n/).forEach(line => {
      const t = line.trim();
      if (!t) return;
      const parts = t.split(',').map(s=>s.trim());
      if (parts.length === 1) rows.push({ assetId: parts[0] });
      else rows.push({ assetId: parts[0], dataset: parts[1] });
    });
    return rows;
  }

  // -------- Single
  const singleAsset = document.getElementById('singleAsset');
  const singleDataset = document.getElementById('singleDataset');
  const singleFormat = document.getElementById('singleFormat');
  const singleGo = document.getElementById('singleGo');
  const singleStatus = document.getElementById('singleStatus');

  singleGo.onclick = async () => {
    const assetId = singleAsset.value.trim();
    const dataset = singleDataset.value;
    const format = singleFormat.value; // kml | geojson | shapefile
    if (!assetId){ singleStatus.textContent = 'Please enter an Asset / BMP ID.'; return; }

    singleGo.disabled = true;
    singleStatus.textContent = 'Working…';
    try {
      await downloadBlob('/api/convert', 'POST', { assetId, dataset, format }, `${assetId}.${format === 'shapefile' ? 'zip' : (format === 'geojson' ? 'geojson' : 'kml')}`);
      singleStatus.innerHTML = '<span class="ok">Done.</span>';
    } catch(e){
      singleStatus.textContent = e.message || 'Error';
    } finally {
      singleGo.disabled = false;
    }
  };

  // -------- Bulk
  const bulkText = document.getElementById('bulkText');
  const bulkDefaultDataset = document.getElementById('bulkDefaultDataset');
  const bulkFormat = document.getElementById('bulkFormat');
  const bulkGo = document.getElementById('bulkGo');
  const bulkStatus = document.getElementById('bulkStatus');

  // drag/drop CSV
  const drop = document.getElementById('drop');
  const file = document.getElementById('file');
  drop.onclick = () => file.click();
  drop.ondragover = (e)=>{ e.preventDefault(); drop.style.background = '#eef4ff' };
  drop.ondragleave = ()=>{ drop.style.background = '#fafbff' };
  drop.ondrop = async (e)=>{
    e.preventDefault(); drop.style.background = '#fafbff';
    const f = e.dataTransfer.files[0]; if (!f) return;
    const text = await f.text();
    bulkText.value = text;
  };
  file.onchange = async () => {
    const f = file.files[0]; if (!f) return;
    const text = await f.text();
    bulkText.value = text;
    file.value = '';
  };

  bulkGo.onclick = async () => {
    bulkGo.disabled = true;
    bulkStatus.textContent = 'Building…';

    try {
      const items = parseCsvText(bulkText.value);
      if (!items.length){ bulkStatus.textContent = 'No rows found.'; bulkGo.disabled = false; return; }
      const defaultDataset = bulkDefaultDataset.value;
      const format = bulkFormat.value; // kml | geojson | shapefile

      await downloadBlob('/api/bulk', 'POST', { items, defaultDataset, format }, `mapbuddy_${format}.zip`);
      bulkStatus.innerHTML = '<span class="ok">Done.</span>';
    } catch(e){
      bulkStatus.textContent = e.message || 'Error';
    } finally {
      bulkGo.disabled = false;
    }
  };
</script>
</body>
</html>
