<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MapBuddy — Asset → KML / GeoJSON / Shapefile</title>
    <style>
      :root{
        --bg:#eaf5f4; --card:#fff; --ink:#123447; --muted:#5f7686;
        --primary:#2d6cdf; --primary-600:#1f57c3; --accent:#ff8a3d;
        --ring:rgba(45,108,223,.25); --line:#e5edf0;
      }
      *{box-sizing:border-box} html,body{height:100%}
      body{
        margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
        color:var(--ink);
        background:
          radial-gradient(1200px 600px at 10% -10%, #ffffff 0%, transparent 60%),
          radial-gradient(900px 500px at 110% 10%, #dff1ff 0%, transparent 55%),
          var(--bg);
      }
      .shell{min-height:100dvh; display:grid; place-items:center; padding:32px 20px}
      .wrap{width:min(1100px,100%)}
      .title{display:flex; align-items:center; gap:14px; margin:0 0 18px}
      .title h1{margin:0; font-size:clamp(22px,3.2vw,40px); font-weight:800; letter-spacing:.2px}
      .pill{padding:8px 12px; border-radius:999px; font-size:12px; font-weight:700; background:#fff; border:1px solid var(--line); color:var(--accent)}
      .sub{margin:0 0 22px; color:var(--muted); font-size:14px}
      .card{background:var(--card); border:1px solid var(--line); border-radius:18px; box-shadow:0 10px 30px rgba(18,52,71,.06); padding:22px}
      .seg{display:flex; gap:10px; justify-content:flex-end; margin-bottom:14px}
      .seg button{appearance:none; border:none; background:#fff; color:var(--ink); padding:10px 18px; border-radius:999px; font-weight:700; border:1px solid var(--line); box-shadow:0 1px 0 rgba(0,0,0,.03); cursor:pointer; transition:.15s}
      .seg button:hover{transform:translateY(-1px)}
      .seg .on{background:linear-gradient(180deg,var(--primary),var(--primary-600)); color:#fff; border-color:transparent; box-shadow:0 6px 16px rgba(45,108,223,.35)}
      .grid{display:grid; gap:14px; grid-template-columns:1fr}
      @media (min-width:880px){ .grid{grid-template-columns:1.2fr 1fr .8fr; align-items:end} }
      label{font-size:12px; font-weight:800; letter-spacing:.4px; color:var(--muted); display:block; margin:2px 0 8px}
      input,select,textarea{width:100%; font-size:16px; color:var(--ink); padding:12px 14px; border-radius:12px; background:#fff; border:1px solid var(--line); outline:none; transition:.15s}
      textarea{min-height:220px; resize:vertical}
      input:focus,select:focus,textarea:focus{border-color:var(--primary); box-shadow:0 0 0 4px var(--ring)}
      .btn{width:100%; padding:14px 18px; border-radius:12px; border:none; cursor:pointer; font-weight:800; color:#fff; letter-spacing:.3px; font-size:16px; background:linear-gradient(180deg,var(--primary),var(--primary-600)); box-shadow:0 10px 24px rgba(45,108,223,.35); transition:.15s}
      .btn:hover{transform:translateY(-1px)} .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
      .row{display:grid; gap:14px} @media (min-width:880px){ .row{grid-template-columns:1fr 1fr} }
      .hint{color:var(--muted); font-size:13px; margin-top:14px}
      .note{background:#fff7ef; color:#7a3a00; border:1px solid #ffd7b1; padding:10px 12px; border-radius:10px; font-size:12px}
      .drop{display:grid; place-items:center; text-align:center; gap:8px; border:2px dashed var(--line); border-radius:14px; padding:18px; color:var(--muted); background:#fbfeff}
      .drop input{display:none} .drop strong{color:var(--ink)}
      .maps{margin-top:10px; font-size:14px} .maps a{color:var(--accent); font-weight:800; text-decoration:none} .maps a:hover{text-decoration:underline}
      .okay{color:#128a43; font-weight:700} .err{color:#b10e3b; font-weight:700}
      .sep{margin:0 8px; color:#8aa;}
    </style>
  </head>
  <body>
    <main class="shell">
      <div class="wrap">
        <div class="title"><h1>MapBuddy — Asset → KML / GeoJSON / Shapefile</h1><span class="pill">v1</span></div>
        <p class="sub">Fast one-offs or bulk lists. Converts ArcGIS features to KML, GeoJSON, or zipped Shapefile via Mapshaper.</p>

        <div class="seg">
          <button id="tab-single" class="on">Single</button>
          <button id="tab-bulk">Bulk</button>
        </div>

        <!-- SINGLE -->
        <section id="single" class="card">
          <div class="grid">
            <div>
              <label>ASSET / BMP ID</label>
              <input id="asset" placeholder="e.g., WP0399, 210049UT, LOD_12345" />
            </div>
            <div>
              <label>DATASET</label>
              <select id="dataset">
                <optgroup label="Fairfax">
                  <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
                </optgroup>
                <optgroup label="MDOT SHA">
                  <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
                  <option value="mdsha_tmdl_any">MDOT SHA — TMDL (Auto-detect)</option>
                  <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
                  <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
                  <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
                  <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
                  <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
                  <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
                </optgroup>
              </select>
            </div>
            <div>
              <label>FORMAT</label>
              <select id="format-single">
                <option value="kml">KML</option>
                <option value="geojson">GeoJSON</option>
                <option value="shp_zip">Shapefile (.zip)</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button id="go" class="btn">Download</button>
          </div>

          <p class="hint"><span class="note">Note</span> MDOT SHA layers may require VPN. MapBuddy saves your last choices locally.</p>
          <div id="status" class="hint" aria-live="polite"></div>
          <div id="mapsLink" class="maps"></div>
        </section>

        <!-- BULK -->
        <section id="bulk" class="card" style="display:none; margin-top:14px;">
          <div class="row">
            <div>
              <label>Paste CSV rows <small>(header optional; columns: <code>assetId</code> or <code>assetId,dataset</code>)</small></label>
              <textarea id="csv" placeholder="WP0399
210049UT
LOD_12345,mdsha_landscape"></textarea>
            </div>
            <div>
              <label>Upload CSV file</label>
              <div class="drop" id="drop">
                <input type="file" id="file" accept=".csv,text/csv" />
                <div>
                  <strong>Drop CSV here</strong> or click to choose
                  <div class="hint">We’ll parse it the same as the textbox.</div>
                </div>
              </div>

              <div style="margin-top:14px;">
                <label>Default dataset <small>(applies to rows without a dataset)</small></label>
                <select id="default-dataset">
                  <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
                  <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
                  <option value="mdsha_tmdl_any">MDOT SHA — TMDL (Auto-detect)</option>
                  <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
                  <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
                  <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
                  <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
                  <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
                  <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
                </select>
              </div>

              <div style="margin-top:14px;">
                <label>FORMAT</label>
                <select id="format-bulk">
                  <option value="kmlzip">KML (.zip)</option>
                  <option value="geojsonzip">GeoJSON (.zip)</option>
                  <option value="shpzip">Shapefile (.zip)</option>
                </select>
              </div>

              <button id="bulk-go" class="btn" style="margin-top:14px;">Download</button>
              <div id="bulk-status" class="hint" aria-live="polite"></div>
            </div>
          </div>

          <p class="hint">Rows that <em>do not</em> include a dataset will use the <strong>Default dataset</strong> dropdown (no auto-detect).</p>
          <p class="hint okay" id="bulk-done" style="display:none;">Done.</p>
        </section>
      </div>
    </main>

    <script>
      // Tabs
      const tabSingle = document.getElementById('tab-single');
      const tabBulk   = document.getElementById('tab-bulk');
      const viewSingle = document.getElementById('single');
      const viewBulk   = document.getElementById('bulk');
      function setMode(m){
        const single = m === 'single';
        tabSingle.classList.toggle('on', single);
        tabBulk.classList.toggle('on', !single);
        viewSingle.style.display = single ? '' : 'none';
        viewBulk.style.display   = single ? 'none' : '';
        localStorage.setItem('mb_mode', m);
      }
      tabSingle.onclick = () => setMode('single');
      tabBulk.onclick   = () => setMode('bulk');
      setMode(localStorage.getItem('mb_mode') || 'single');

      // Elements
      const assetEl  = document.getElementById('asset');
      const dsEl     = document.getElementById('dataset');
      const fmtSingleEl = document.getElementById('format-single');
      const statusEl = document.getElementById('status');
      const mapsEl   = document.getElementById('mapsLink');
      const goBtn    = document.getElementById('go');

      const csvEl    = document.getElementById('csv');
      const defaultDsEl = document.getElementById('default-dataset');
      const fmtBulkEl   = document.getElementById('format-bulk');
      const bulkBtn     = document.getElementById('bulk-go');
      const bulkStatus  = document.getElementById('bulk-status');
      const bulkDone    = document.getElementById('bulk-done');

      // Persist selections
      [dsEl, fmtSingleEl, defaultDsEl, fmtBulkEl].forEach(sel=>{
        const key='mb_'+sel.id, saved=localStorage.getItem(key);
        if(saved) sel.value=saved;
        sel.addEventListener('change',()=>localStorage.setItem(key, sel.value));
      });
      const savedAsset=localStorage.getItem('mb_asset'); if(savedAsset) assetEl.value=savedAsset;
      assetEl.addEventListener('input',()=>localStorage.setItem('mb_asset', assetEl.value));

      // Dropzone
      const drop=document.getElementById('drop'), file=document.getElementById('file');
      drop.addEventListener('click',()=>file.click());
      drop.addEventListener('dragover',e=>{e.preventDefault(); drop.style.borderColor='var(--primary)';});
      drop.addEventListener('dragleave',()=>{drop.style.borderColor='var(--line)';});
      drop.addEventListener('drop',e=>{e.preventDefault(); drop.style.borderColor='var(--line)'; if(e.dataTransfer.files?.length) file.files=e.dataTransfer.files, readCsv();});
      file.addEventListener('change',readCsv);
      function readCsv(){ const f=file.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ csvEl.value=String(r.result||'').trim(); }; r.readAsText(f); }

      // API helpers
      async function locate(asset, dataset) {
        const r = await fetch('/api/locate', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ assetId: asset, dataset })
        });
        if (!r.ok) {
          let msg = `Locate failed (HTTP ${r.status})`;
          try { const err = await r.json(); if (err?.error) msg = err.error; } catch {}
          throw new Error(msg);
        }
        return r.json();
      }

      // Single: Download geodata & show maps link with "Copy link"
      async function downloadSingle() {
        const asset = assetEl.value.trim();
        const dataset = dsEl.value;
        const format  = fmtSingleEl.value;
        if(!asset){ statusEl.innerHTML='<span class="err">Please enter an Asset / BMP ID.</span>'; return; }

        mapsEl.innerHTML=''; goBtn.disabled=true; statusEl.textContent='Locating…';

        try{
          const info = await locate(asset, dataset);
          if (info?.googleMapsUrl) {
            mapsEl.innerHTML = `
              <a href="${info.googleMapsUrl}" target="_blank" rel="noopener">Open in Google Maps</a>
              <span class="sep">•</span>
              <a href="#" id="copyLink">Copy link</a>
              ${info?.centroid ? ` <span class="hint">· lat ${info.centroid.lat.toFixed(6)}, lng ${info.centroid.lng.toFixed(6)}</span>` : ''}
            `;
            const copy = document.getElementById('copyLink');
            copy.addEventListener('click', async (e) => {
              e.preventDefault();
              try {
                if (navigator.clipboard?.writeText) {
                  await navigator.clipboard.writeText(info.googleMapsUrl);
                } else {
                  const ta = document.createElement('textarea');
                  ta.value = info.googleMapsUrl;
                  document.body.appendChild(ta);
                  ta.select();
                  document.execCommand('copy');
                  document.body.removeChild(ta);
                }
                const old = statusEl.textContent;
                statusEl.textContent = 'Link copied!';
                setTimeout(() => { if (statusEl.textContent === 'Link copied!') statusEl.textContent = old; }, 1200);
              } catch {
                statusEl.textContent = 'Could not copy link.';
              }
            });
          }

          statusEl.textContent='Converting…';
          const resp = await fetch('/api/convert', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ assetId: asset, dataset, format })
          });
          if(!resp.ok){
            let msg=`Conversion failed (HTTP ${resp.status})`;
            try{ const err=await resp.json(); if(err?.error) msg='Conversion failed: '+err.error; }catch{}
            throw new Error(msg);
          }
          const blob=await resp.blob();
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.download = `${asset}.${format.startsWith('shp')?'zip':(format.includes('geojson')?'geojson':'kml')}`;
          a.href=url; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          statusEl.innerHTML='<span class="okay">Done.</span>';
        }catch(err){
          statusEl.innerHTML=`<span class="err">${err.message||'Error'}</span>`;
        }finally{
          goBtn.disabled=false;
        }
      }

      function parseCsv(text){
        const rows=[], lines=(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if(!lines.length) return rows;
        const maybeHeader=lines[0].toLowerCase();
        const hasHeader=maybeHeader.includes('asset')||maybeHeader.includes('dataset');
        const start=hasHeader?1:0;
        for(let i=start;i<lines.length;i++){
          const parts=lines[i].split(',').map(s=>s.trim());
          if(!parts[0]) continue;
          rows.push({assetId:parts[0], dataset:parts[1]||null});
        }
        return rows;
      }

      async function downloadBulk(){
        const items=parseCsv(csvEl.value);
        const format=fmtBulkEl.value;          // "kmlzip" | "geojsonzip" | "shpzip"
        const defaultDataset=defaultDsEl.value;

        bulkStatus.textContent=''; bulkDone.style.display='none';
        if(!items.length){ bulkStatus.innerHTML='<span class="err">Paste or upload a CSV first.</span>'; return; }

        bulkBtn.disabled=true; bulkStatus.textContent='Building zip…';
        try{
          const resp=await fetch('/api/bulk',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ items, defaultDataset, format })
          });
          if(!resp.ok){
            let msg=`Bulk failed (HTTP ${resp.status})`;
            try{ const err=await resp.json(); if(err?.error) msg='Bulk failed: '+err.error; }catch{}
            throw new Error(msg);
          }
          const blob=await resp.blob();
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.download = format==='kmlzip'?'mapbuddy_kml.zip':format==='geojsonzip'?'mapbuddy_geojson.zip':'mapbuddy_shapefile.zip';
          a.href=url; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          bulkStatus.textContent=''; bulkDone.style.display='';
        }catch(err){
          bulkStatus.innerHTML=`<span class="err">${err.message||'Error'}</span>`;
        }finally{
          bulkBtn.disabled=false;
        }
      }

      document.getElementById('go').addEventListener('click', downloadSingle);
      assetEl.addEventListener('keydown', e=>{ if(e.key==='Enter') downloadSingle(); });
      document.getElementById('bulk-go').addEventListener('click', downloadBulk);
    </script>
  </body>
</html>
