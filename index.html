<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>MapBuddy ‚Äî Convert Assets to Map Files</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mbBlue: "#2563eb",
            mbGreen: "#059669",
          },
          boxShadow: {
            soft: "0 10px 30px rgba(2, 6, 23, .06)",
          },
        },
      },
    };
  </script>

  <style>
    /* pill toggles */
    .pill {
      @apply inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:border-slate-400 transition;
    }
    .pill[data-active="true"] {
      background-image: linear-gradient(90deg, #2563eb, #059669);
      @apply border-transparent text-white shadow;
    }

    /* primary gradient buttons */
    .btn-primary {
      background-image: linear-gradient(90deg, #2563eb, #059669);
      @apply inline-flex items-center justify-center rounded-xl px-5 py-3 text-white font-semibold shadow hover:opacity-95 disabled:opacity-50 disabled:cursor-not-allowed transition;
    }
    /* subtle gradient for secondary actions (copy, choose file)  */
    .btn-secondary {
      background-image: linear-gradient(90deg, #2563eb, #059669);
      background-clip: padding-box, border-box;
      background-origin: border-box;
      background-repeat: no-repeat;
      box-shadow: 0 0 0 1.5px transparent inset;
      @apply inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-white;
    }

    /* dropzone */
    .dropzone {
      @apply rounded-2xl border-2 border-dashed border-slate-300 bg-white p-8 text-center transition;
    }
    .dropzone.dragover {
      @apply border-mbBlue bg-blue-50;
    }

    /* container card */
    .card {
      @apply rounded-3xl bg-white p-6 shadow-soft;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-blue-50 text-slate-900">

  <!-- Header -->
  <header class="border-b border-slate-200 bg-white">
    <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-4">
      <div class="flex items-center gap-3">
        <div class="grid h-9 w-9 place-items-center rounded-xl bg-gradient-to-r from-mbBlue to-mbGreen text-white">
          <!-- simple map glyph -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 3 3 6v15l6-3 6 3 6-3V3l-6 3-6-3Z" />
            <path d="M9 3v15M15 6v15" />
          </svg>
        </div>
        <span class="text-xl font-bold">MapBuddy</span>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="mx-auto max-w-6xl px-4 pt-10 pb-2">
    <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">
      Convert Assets to
      <span class="bg-gradient-to-r from-mbBlue to-mbGreen bg-clip-text text-transparent">Map Files</span>
    </h1>
    <p class="mt-4 max-w-3xl text-lg text-slate-600">
      Transform asset numbers into KML, GeoJSON, Shapefile. Single asset or bulk processing available.
    </p>

    <!-- Mode toggle -->
    <div class="mt-6 inline-flex rounded-full bg-white p-1 shadow-soft">
      <button id="modeSingle" class="pill !rounded-full px-5 py-2" data-active="true">Single</button>
      <button id="modeBulk" class="pill !rounded-full px-5 py-2" data-active="false">Bulk</button>
    </div>
  </section>

  <!-- Single card -->
  <section id="singleCard" class="mx-auto max-w-6xl px-4 pb-10">
    <div class="card">
      <div class="grid gap-4 md:grid-cols-3 md:gap-6">
        <!-- Asset -->
        <div>
          <label class="mb-2 block text-sm font-semibold">Asset / BMP ID</label>
          <input id="singleAsset"
                 class="w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-slate-900 outline-none focus:border-mbBlue"
                 placeholder="e.g., WP0399, 210049UT, LOD_12345" />
        </div>

        <!-- Dataset -->
        <div>
          <label class="mb-2 block text-sm font-semibold">Dataset</label>
          <select id="singleDataset"
                  class="w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-slate-900 outline-none focus:border-mbBlue">
            <!-- Fairfax -->
            <option value="fairfax_bmps">Fairfax ‚Äî Stormwater Facilities (FACILITY_ID)</option>

            <!-- MDOT SHA -->
            <option value="mdsha_lod">MDOT SHA ‚Äî Managed Landscape (LOD_ID)</option>

            <optgroup label="MDOT SHA ‚Äî TMDL">
              <option value="mdsha_tmdl_structures">TMDL ‚Äî Stormwater Control Structures</option>
              <option value="mdsha_tmdl_retrofits">TMDL ‚Äî Retrofits</option>
              <option value="mdsha_tmdl_tree_plantings">TMDL ‚Äî Tree Plantings</option>
              <option value="mdsha_tmdl_pavement_removals">TMDL ‚Äî Pavement Removals</option>
              <option value="mdsha_tmdl_stream_restorations">TMDL ‚Äî Stream Restorations</option>
              <option value="mdsha_tmdl_outfall_stabilizations">TMDL ‚Äî Outfall Stabilizations</option>
            </optgroup>
          </select>
        </div>

        <!-- Format -->
        <div>
          <label class="mb-2 block text-sm font-semibold">Format</label>
          <div id="singleFormat" class="flex flex-wrap gap-2">
            <button class="pill" data-format="kml" data-active="true">üó∫Ô∏è KML</button>
            <button class="pill" data-format="geojson" data-active="false">üìä GeoJSON</button>
            <button class="pill" data-format="shapefile" data-active="false">üóÉÔ∏è Shapefile (.zip)</button>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="mt-6 flex flex-wrap items-center gap-3">
        <button id="singleDownload" class="btn-primary">Download</button>

        <a id="openGMaps"
           href="#"
           target="_blank"
           rel="noopener"
           class="pill !rounded-xl">Open in Google Maps ‚Üí</a>

        <button id="copyLink" class="btn-secondary">Copy link</button>

        <span id="singleStatus" class="ml-2 text-sm text-slate-500">Done.</span>

        <span class="ml-auto inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-sm text-slate-700">
          <span class="font-semibold text-slate-600">Note</span>
          MDOT SHA layers may require VPN.
        </span>
      </div>
    </div>
  </section>

  <!-- Bulk card -->
  <section id="bulkCard" class="mx-auto hidden max-w-6xl px-4 pb-16">
    <div class="card">
      <h3 class="mb-4 text-xl font-semibold">Bulk Asset Conversion</h3>

      <div class="grid gap-6 lg:grid-cols-2">
        <!-- Left: Dataset + Dropzone + requirements -->
        <div>
          <label class="mb-2 block text-sm font-semibold">Dataset</label>
          <select id="bulkDataset"
                  class="mb-4 w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-slate-900 outline-none focus:border-mbBlue">
            <option value="fairfax_bmps">Fairfax ‚Äî Stormwater Facilities (FACILITY_ID)</option>
            <option value="mdsha_lod">MDOT SHA ‚Äî Managed Landscape (LOD_ID)</option>
            <optgroup label="MDOT SHA ‚Äî TMDL">
              <option value="mdsha_tmdl_structures">TMDL ‚Äî Stormwater Control Structures</option>
              <option value="mdsha_tmdl_retrofits">TMDL ‚Äî Retrofits</option>
              <option value="mdsha_tmdl_tree_plantings">TMDL ‚Äî Tree Plantings</option>
              <option value="mdsha_tmdl_pavement_removals">TMDL ‚Äî Pavement Removals</option>
              <option value="mdsha_tmdl_stream_restorations">TMDL ‚Äî Stream Restorations</option>
              <option value="mdsha_tmdl_outfall_stabilizations">TMDL ‚Äî Outfall Stabilizations</option>
            </optgroup>
          </select>

          <!-- Dropzone -->
          <div id="dz" class="dropzone">
            <div class="mx-auto mb-3 grid h-12 w-12 place-items-center rounded-full bg-gradient-to-r from-mbBlue to-mbGreen text-white">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 21V7m0 0-4 4m4-4 4 4" />
                <path d="M20 21H4a2 2 0 0 1-2-2v0a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2Z"/>
              </svg>
            </div>
            <p class="text-base font-semibold">Drop your CSV file here</p>
            <p class="mt-1 text-slate-500">or click to browse</p>
            <input id="csvInput" type="file" accept=".csv" class="hidden" />
            <div class="mt-3">
              <button id="chooseCsv" class="btn-secondary">Choose CSV File</button>
            </div>
          </div>

          <!-- Requirements -->
          <div class="mt-5 rounded-2xl border border-blue-200 bg-blue-50 p-4">
            <h4 class="mb-2 font-semibold text-blue-900">CSV Format Requirements:</h4>
            <ul class="text-sm text-blue-900/90 leading-6 list-disc pl-5">
              <li>First column: Asset numbers</li>
              <li>Header row optional</li>
              <li>Up to 1000 assets per file</li>
              <li>Optional second column: dataset key</li>
            </ul>
          </div>
        </div>

        <!-- Right: Output formats -->
        <div>
          <label class="mb-2 block text-sm font-semibold">Output Formats</label>
          <div id="bulkFormat" class="space-y-3">
            <button class="pill w-full justify-between" data-format="kml" data-active="true">
              <span class="flex items-center gap-3"><span>üó∫Ô∏è</span> <span class="font-medium">KML Files</span></span>
              <span class="text-sm text-slate-600">Google Earth format</span>
            </button>
            <button class="pill w-full justify-between" data-format="geojson" data-active="false">
              <span class="flex items-center gap-3"><span>üìä</span> <span class="font-medium">GeoJSON Files</span></span>
              <span class="text-sm text-slate-600">Web mapping format</span>
            </button>
            <button class="pill w-full justify-between" data-format="shapefile" data-active="false">
              <span class="flex items-center gap-3"><span>üóÉÔ∏è</span> <span class="font-medium">Shapefile</span></span>
              <span class="text-sm text-slate-600">GIS standard format</span>
            </button>

            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <div class="font-semibold">Google Maps Links</div>
              <div class="text-sm text-slate-600">
                Direct map links (CSV) ‚Äî included with bulk.
              </div>
            </div>
          </div>

          <div class="mt-6">
            <button id="bulkProcess" class="btn-primary">Process Bulk Conversion</button>
            <span id="bulkStatus" class="ml-3 text-sm text-slate-500"></span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="border-t border-slate-200 bg-white">
    <div class="mx-auto max-w-6xl px-4 py-8 text-center text-slate-600">
      ¬© 2025 MapBuddy ¬∑ Simple, reliable asset-to-map conversion.
    </div>
  </footer>

  <script>
    // ---------------------------
    // helpers
    // ---------------------------
    function setExclusiveActive(container, targetBtn) {
      container.querySelectorAll(".pill").forEach((b) => b.setAttribute("data-active","false"));
      targetBtn.setAttribute("data-active","true");
    }

    function activeFormat(container) {
      const active = container.querySelector('.pill[data-active="true"]');
      return active ? active.getAttribute("data-format") : null;
    }

    function filenameFromHeaders(headers, fallback) {
      const cd = headers.get("content-disposition") || "";
      const match = cd.match(/filename="?([^"]+)"?/i);
      return match ? match[1] : fallback;
    }

    async function downloadBlob(resp, fallbackName) {
      if (!resp.ok) {
        const txt = await resp.text().catch(()=>"");
        throw new Error(`Request failed (${resp.status}): ${txt || "Unknown error"}`);
      }
      const blob = await resp.blob();
      const name = filenameFromHeaders(resp.headers, fallbackName);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function fetchGmapLink(assetId, dataset) {
      try {
        const u = new URL("/api/locate", location.origin);
        u.searchParams.set("assetId", assetId.trim());
        u.searchParams.set("dataset", dataset);
        const resp = await fetch(u);
        if (!resp.ok) throw new Error("locate failed");
        const j = await resp.json();
        return j.gmaps || (j.lat && j.lng ? `https://www.google.com/maps/search/?api=1&query=${j.lat},${j.lng}` : "#");
      } catch {
        return "#";
      }
    }

    // ---------------------------
    // Mode switching
    // ---------------------------
    const modeSingleBtn = document.getElementById("modeSingle");
    const modeBulkBtn = document.getElementById("modeBulk");
    const singleCard = document.getElementById("singleCard");
    const bulkCard = document.getElementById("bulkCard");

    function showSingle() {
      modeSingleBtn.setAttribute("data-active","true");
      modeBulkBtn.setAttribute("data-active","false");
      singleCard.classList.remove("hidden");
      bulkCard.classList.add("hidden");
    }
    function showBulk() {
      modeSingleBtn.setAttribute("data-active","false");
      modeBulkBtn.setAttribute("data-active","true");
      singleCard.classList.add("hidden");
      bulkCard.classList.remove("hidden");
    }
    modeSingleBtn.addEventListener("click", showSingle);
    modeBulkBtn.addEventListener("click", showBulk);

    // ---------------------------
    // Single logic
    // ---------------------------
    const singleAsset = document.getElementById("singleAsset");
    const singleDataset = document.getElementById("singleDataset");
    const singleFormatGroup = document.getElementById("singleFormat");
    const singleDownload = document.getElementById("singleDownload");
    const singleStatus = document.getElementById("singleStatus");
    const openGMaps = document.getElementById("openGMaps");
    const copyLinkBtn = document.getElementById("copyLink");

    // format pills
    singleFormatGroup.querySelectorAll(".pill").forEach((btn) => {
      btn.addEventListener("click", () => setExclusiveActive(singleFormatGroup, btn));
    });

    async function updateGmapLinkPreview() {
      const id = singleAsset.value.trim();
      if (!id) { openGMaps.href = "#"; return; }
      const ds = singleDataset.value;
      const link = await fetchGmapLink(id, ds);
      openGMaps.href = link;
    }

    singleAsset.addEventListener("input", updateGmapLinkPreview);
    singleDataset.addEventListener("change", updateGmapLinkPreview);

    copyLinkBtn.addEventListener("click", async () => {
      const id = singleAsset.value.trim();
      if (!id) return;
      const ds = singleDataset.value;
      const link = await fetchGmapLink(id, ds);
      try {
        await navigator.clipboard.writeText(link);
        singleStatus.textContent = "Google Maps link copied.";
      } catch {
        singleStatus.textContent = "Copy failed.";
      }
    });

    singleDownload.addEventListener("click", async () => {
      const assetId = singleAsset.value.trim();
      const dataset = singleDataset.value;
      const format = activeFormat(singleFormatGroup) || "kml";
      if (!assetId) {
        singleStatus.textContent = "Please enter an asset ID.";
        return;
      }
      singleDownload.disabled = true;
      singleStatus.textContent = "Working‚Ä¶";

      try {
        const resp = await fetch("/api/convert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ assetId, dataset, format }),
        });
        const fallback =
          format === "kml" ? `${assetId}.kml` :
          format === "geojson" ? `${assetId}.geojson` : `${assetId}.zip`;
        await downloadBlob(resp, fallback);
        singleStatus.textContent = "Done.";
      } catch (err) {
        singleStatus.textContent = err.message || "Failed.";
      } finally {
        singleDownload.disabled = false;
      }
    });

    // ---------------------------
    // Bulk logic
    // ---------------------------
    const dz = document.getElementById("dz");
    const csvInput = document.getElementById("csvInput");
    const chooseCsv = document.getElementById("chooseCsv");
    const bulkDataset = document.getElementById("bulkDataset");
    const bulkFormatGroup = document.getElementById("bulkFormat");
    const bulkProcess = document.getElementById("bulkProcess");
    const bulkStatus = document.getElementById("bulkStatus");

    // format pills (exclusive selection)
    bulkFormatGroup.querySelectorAll(".pill").forEach((btn) => {
      btn.addEventListener("click", () => setExclusiveActive(bulkFormatGroup, btn));
    });

    // CSV choose
    chooseCsv.addEventListener("click", () => csvInput.click());
    dz.addEventListener("click", () => csvInput.click());

    // drag behavior
    dz.addEventListener("dragover", (e) => { e.preventDefault(); dz.classList.add("dragover"); });
    dz.addEventListener("dragleave", () => dz.classList.remove("dragover"));
    dz.addEventListener("drop", (e) => {
      e.preventDefault();
      dz.classList.remove("dragover");
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        csvInput.files = e.dataTransfer.files;
      }
    });

    function parseCsv(text) {
      // Accepts:
      //   assetId
      // or assetId,dataset
      const lines = text.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
      if (!lines.length) return [];
      // detect header (very light)
      const first = lines[0].toLowerCase();
      const startIdx = first.includes("asset") ? 1 : 0;

      const items = [];
      for (let i = startIdx; i < lines.length; i++) {
        const parts = lines[i].split(",").map((p) => p.trim()).filter(Boolean);
        if (!parts.length) continue;
        const assetId = parts[0];
        const dataset = parts[1] || null;
        items.push({ assetId, dataset });
      }
      return items;
    }

    bulkProcess.addEventListener("click", async () => {
      if (!csvInput.files || !csvInput.files[0]) {
        bulkStatus.textContent = "Please select a CSV file.";
        return;
      }
      const dsDefault = bulkDataset.value;
      const format = activeFormat(bulkFormatGroup) || "kml";

      bulkProcess.disabled = true;
      bulkStatus.textContent = "Processing‚Ä¶";

      try {
        const text = await csvInput.files[0].text();
        const rows = parseCsv(text);
        if (!rows.length) throw new Error("CSV was empty.");

        // Normalize items: if a row lacks dataset, use default
        const items = rows.map((r) => ({
          assetId: r.assetId,
          dataset: r.dataset || undefined,
        }));

        const resp = await fetch("/api/bulk", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            items,
            defaultDataset: dsDefault,
            format, // backend already zips kml/geojson and includes the google-links CSV
          }),
        });
        const fallback =
          format === "kml" ? "mapbuddy_kml.zip" :
          format === "geojson" ? "mapbuddy_geojson.zip" : "mapbuddy_shapefile.zip";

        await downloadBlob(resp, fallback);
        bulkStatus.textContent = "Done.";
      } catch (err) {
        bulkStatus.textContent = err.message || "Failed.";
      } finally {
        bulkProcess.disabled = false;
      }
    });

    // Initialize preview link
    updateGmapLinkPreview();
  </script>
</body>
</html>
