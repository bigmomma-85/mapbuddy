<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>MapBuddy — Asset → Map Files</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mbBlue: "#2563eb",
            mbGreen: "#059669",
          },
          boxShadow: {
            card: "0 8px 30px rgba(2, 6, 23, 0.08)",
          },
        },
      },
    };
  </script>

  <style>
    /* Small helpers for focus + transitions */
    .btn {
      @apply inline-flex items-center justify-center rounded-xl px-4 py-2 font-semibold text-white
             bg-gradient-to-r from-mbBlue via-blue-500 to-mbGreen shadow
             hover:shadow-lg hover:brightness-105 active:scale-[.99]
             disabled:opacity-50 disabled:cursor-not-allowed;
    }
    .btn-lg { @apply px-5 py-3 text-base; }
    .btn-ghost {
      @apply inline-flex items-center justify-center rounded-xl px-3 py-2 font-medium
             text-slate-700 hover:bg-slate-100;
    }
    .pill {
      @apply inline-flex items-center rounded-full px-4 py-2 text-sm font-semibold
             bg-white text-slate-700 border border-slate-200 shadow-sm;
    }
    .pill-active {
      @apply text-white bg-gradient-to-r from-mbBlue via-blue-500 to-mbGreen border-0;
    }
    .card {
      @apply bg-white rounded-2xl shadow-card border border-slate-100;
    }
    .label {
      @apply block text-sm font-semibold text-slate-700 mb-1.5;
    }
    .input, .select {
      @apply w-full rounded-xl border border-slate-300 bg-white px-4 py-2.5
             text-slate-900 placeholder-slate-400
             focus:outline-none focus:ring-2 focus:ring-mbBlue focus:border-transparent;
    }
    .hint { @apply text-sm text-slate-500; }
    .note { @apply inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-sm text-slate-700; }
    .dot { @apply w-2 h-2 rounded-full bg-slate-400; }
    .dash {
      @apply border-2 border-dashed border-slate-300 rounded-2xl p-8 text-center
             hover:border-mbBlue transition-colors cursor-pointer;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-slate-50 to-blue-50 text-slate-900">
  <!-- Header -->
  <header class="bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-lg bg-gradient-to-r from-mbBlue to-mbGreen grid place-items-center text-white font-bold">
          <span class="text-lg">M</span>
        </div>
        <span class="text-xl font-bold">MapBuddy</span>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="mx-auto max-w-6xl px-4 pt-10 pb-4">
    <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">
      Convert Assets to
      <span class="bg-gradient-to-r from-mbBlue via-blue-500 to-mbGreen bg-clip-text text-transparent">
        Map Files
      </span>
    </h1>
    <p class="mt-4 text-lg text-slate-600">
      Transform asset numbers into KML, GeoJSON, Shapefile. Single asset or bulk processing available.
    </p>

    <!-- Mode pills -->
    <div class="mt-6 flex items-center gap-3">
      <button id="btnSingleTab" class="pill pill-active" type="button">Single</button>
      <button id="btnBulkTab" class="pill" type="button">Bulk</button>
    </div>
  </section>

  <!-- Single card -->
  <main class="mx-auto max-w-6xl px-4 pb-16">
    <section id="singleCard" class="card p-6 sm:p-8">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Asset -->
        <div>
          <label class="label">Asset / BMP ID</label>
          <input id="singleAsset" class="input" placeholder="e.g., WP0399, 210049UT, LOD_12345" />
        </div>

        <!-- Dataset -->
        <div>
          <label class="label">Dataset</label>
          <select id="singleDataset" class="select">
            <!-- Fairfax -->
            <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>

            <!-- MDOT SHA / LOD -->
            <option value="mdsha_lod">MDOT SHA — Managed Landscape (LOD_ID)</option>

            <optgroup label="MDOT SHA — TMDL">
              <option value="mdsha_tmdl_scs">TMDL — Stormwater Control Structures</option>
              <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
              <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
              <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
              <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
              <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
            </optgroup>
          </select>
        </div>

        <!-- Format (DROPDOWN) -->
        <div>
          <label class="label">Format</label>
          <select id="singleFormat" class="select">
            <option value="kml">KML</option>
            <option value="geojson">GeoJSON</option>
            <option value="shapefile">Shapefile (.zip)</option>
          </select>
        </div>
      </div>

      <!-- Actions -->
      <div class="mt-6 flex flex-wrap items-center gap-3">
        <button id="btnSingleDownload" class="btn btn-lg" type="button">Download</button>

        <a id="aOpenGMaps" class="btn-ghost" href="#" target="_blank" rel="noopener">
          Open in Google Maps →
        </a>

        <button id="btnCopyGMaps" class="btn btn-lg" type="button">Copy link</button>

        <span id="singleStatus" class="hint">Done.</span>
      </div>

      <div class="mt-4">
        <span class="note"><span class="dot"></span> MDOT SHA layers may require VPN.</span>
      </div>
    </section>

    <!-- Bulk card -->
    <section id="bulkCard" class="card p-6 sm:p-8 mt-8 hidden">
      <h2 class="sr-only">Bulk Asset Conversion</h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left: dataset + dropzone + csv rules -->
        <div>
          <label class="label">Dataset</label>
          <select id="bulkDataset" class="select mb-6">
            <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
            <option value="mdsha_lod">MDOT SHA — Managed Landscape (LOD_ID)</option>
            <optgroup label="MDOT SHA — TMDL">
              <option value="mdsha_tmdl_scs">TMDL — Stormwater Control Structures</option>
              <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
              <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
              <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
              <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
              <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
            </optgroup>
          </select>

          <!-- Dropzone -->
          <label class="label">Upload CSV</label>
          <div id="dropZone" class="dash">
            <div class="mx-auto mb-3 h-12 w-12 rounded-full bg-gradient-to-r from-mbBlue to-mbGreen grid place-items-center text-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
            </div>
            <p class="font-semibold">Drop your CSV file here</p>
            <p class="hint">or click to browse</p>
            <div class="mt-4">
              <label class="btn btn-lg cursor-pointer">
                <input id="bulkFile" type="file" accept=".csv" class="hidden" />
                Choose CSV File
              </label>
            </div>
          </div>

          <!-- CSV rules -->
          <div class="mt-6 rounded-2xl border border-blue-200 bg-blue-50 p-4">
            <p class="font-semibold text-blue-900 mb-2">CSV Format Requirements:</p>
            <ul class="text-sm text-blue-800 space-y-1">
              <li>• First column: Asset numbers</li>
              <li>• Header row optional</li>
              <li>• Up to 1000 assets per file</li>
              <li>• Optional second column: dataset key</li>
            </ul>
          </div>
        </div>

        <!-- Right: format dropdown + gmaps info + action -->
        <div>
          <label class="label">Output Format</label>
          <select id="bulkFormat" class="select">
            <option value="kmlzip">KML (.zip)</option>
            <option value="geojsonzip">GeoJSON (.zip)</option>
            <option value="shapefile">Shapefile (.zip)</option>
          </select>

          <div class="mt-6 rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <p class="font-semibold text-slate-900 mb-1">Google Maps Links</p>
            <p class="hint">Direct map links (CSV) — included with bulk.</p>
          </div>

          <div class="mt-6">
            <button id="btnBulkProcess" class="btn btn-lg" type="button">Process Bulk Conversion</button>
            <span id="bulkStatus" class="ml-3 hint align-middle"></span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="py-10 text-center text-slate-500">
    © 2025 MapBuddy · Simple, reliable asset-to-map conversion.
  </footer>

  <script>
    // -------------------------------
    // Tab switching
    // -------------------------------
    const singleTabBtn = document.getElementById("btnSingleTab");
    const bulkTabBtn   = document.getElementById("btnBulkTab");
    const singleCard   = document.getElementById("singleCard");
    const bulkCard     = document.getElementById("bulkCard");

    function setMode(mode) {
      const singleActive = mode === "single";
      singleCard.classList.toggle("hidden", !singleActive);
      bulkCard.classList.toggle("hidden", singleActive);
      singleTabBtn.classList.toggle("pill-active", singleActive);
      bulkTabBtn.classList.toggle("pill-active", !singleActive);
    }
    singleTabBtn.addEventListener("click", () => setMode("single"));
    bulkTabBtn.addEventListener("click", () => setMode("bulk"));

    // -------------------------------
    // Elements (Single)
    // -------------------------------
    const singleAsset   = document.getElementById("singleAsset");
    const singleDataset = document.getElementById("singleDataset");
    const singleFormat  = document.getElementById("singleFormat");
    const btnSingleDownload = document.getElementById("btnSingleDownload");
    const singleStatus  = document.getElementById("singleStatus");
    const aOpenGMaps    = document.getElementById("aOpenGMaps");
    const btnCopyGMaps  = document.getElementById("btnCopyGMaps");

    let currentGMapsUrl = "";

    // Helper: simple robust find in returned JSON for a Google Maps URL shape
    function extractGMapsUrl(obj) {
      const asText = JSON.stringify(obj);
      const match = asText.match(/https?:\/\/www\.google\.com\/maps[^\s"']+/);
      return match ? match[0] : "";
    }

    async function refreshGMapsLink() {
      currentGMapsUrl = "";
      aOpenGMaps.href = "#";
      btnCopyGMaps.disabled = true;

      const id = singleAsset.value.trim();
      const ds = singleDataset.value;
      if (!id) return;

      try {
        // Your repo already has api/locate.js; call it to get a link or coords
        const res = await fetch(`/api/locate?id=${encodeURIComponent(id)}&dataset=${encodeURIComponent(ds)}`);
        if (res.ok) {
          const data = await res.json().catch(() => ({}));
          const url = data.googleMapsUrl || data.url || data.href || extractGMapsUrl(data);
          if (url) {
            currentGMapsUrl = url;
            aOpenGMaps.href = url;
            btnCopyGMaps.disabled = false;
          }
        }
      } catch (_) { /* no-op */ }
    }

    singleAsset.addEventListener("input", refreshGMapsLink);
    singleDataset.addEventListener("change", refreshGMapsLink);

    btnCopyGMaps.addEventListener("click", async () => {
      if (!currentGMapsUrl) return;
      try {
        await navigator.clipboard.writeText(currentGMapsUrl);
        singleStatus.textContent = "Link copied.";
      } catch {
        singleStatus.textContent = "Copy failed.";
      }
    });

    // -------------------------------
    // Single: Download
    // -------------------------------
    btnSingleDownload.addEventListener("click", async () => {
      const id = singleAsset.value.trim();
      const ds = singleDataset.value;
      const fmt = singleFormat.value; // "kml" | "geojson" | "shapefile"
      if (!id) {
        singleStatus.textContent = "Enter an asset ID.";
        return;
      }
      singleStatus.textContent = "Working…";

      try {
        const res = await fetch("/api/convert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ assetId: id, dataset: ds, format: fmt }),
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || `HTTP ${res.status}`);
        }

        const blob = await res.blob();
        const cd = res.headers.get("content-disposition") || "";
        // try to extract filename= from header; otherwise fallback
        const m = cd.match(/filename="?([^"]+)"?/i);
        const filename = m ? m[1] : `mapbuddy.${fmt === "kml" ? "kml" : fmt === "geojson" ? "geojson" : "zip"}`;

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        singleStatus.textContent = "Done.";
      } catch (err) {
        singleStatus.textContent = `Error: ${err.message || err}`;
      }
    });

    // -------------------------------
    // Bulk
    // -------------------------------
    const bulkDataset  = document.getElementById("bulkDataset");
    const bulkFormat   = document.getElementById("bulkFormat"); // "kmlzip" | "geojsonzip" | "shapefile"
    const bulkFile     = document.getElementById("bulkFile");
    const dropZone     = document.getElementById("dropZone");
    const btnBulkProcess = document.getElementById("btnBulkProcess");
    const bulkStatus   = document.getElementById("bulkStatus");

    // Click-to-browse
    dropZone.addEventListener("click", () => bulkFile.click());

    // Drag & drop
    ;["dragenter","dragover"].forEach(ev =>
      dropZone.addEventListener(ev, e => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add("border-mbBlue");
      })
    );
    ;["dragleave","drop"].forEach(ev =>
      dropZone.addEventListener(ev, e => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove("border-mbBlue");
      })
    );
    dropZone.addEventListener("drop", e => {
      const f = e.dataTransfer?.files?.[0];
      if (f) bulkFile.files = e.dataTransfer.files;
    });

    function parseCsv(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (lines.length === 0) return [];
      // Detect header: if first row has non-alnum or contains comma > 1 etc.
      // We’ll accept either:
      //   assetId
      //   assetId,dataset
      //   OR header row then values
      const maybeHeader = lines[0].toLowerCase();
      const hasHeader = /asset|dataset/.test(maybeHeader);
      const start = hasHeader ? 1 : 0;

      const items = [];
      for (let i = start; i < lines.length; i++) {
        const parts = lines[i].split(",").map(s => s.trim()).filter(Boolean);
        if (!parts[0]) continue;
        const item = { assetId: parts[0] };
        if (parts[1]) item.dataset = parts[1];
        items.push(item);
      }
      return items;
    }

    btnBulkProcess.addEventListener("click", async () => {
      const file = bulkFile.files?.[0];
      if (!file) {
        bulkStatus.textContent = "Please choose a CSV file.";
        return;
      }
      bulkStatus.textContent = "Parsing CSV…";

      try {
        const text = await file.text();
        const items = parseCsv(text);
        if (items.length === 0) {
          bulkStatus.textContent = "No items found in CSV.";
          return;
        }

        const payload = {
          items,
          defaultDataset: bulkDataset.value,
          format: bulkFormat.value, // "kmlzip" | "geojsonzip" | "shapefile"
        };

        bulkStatus.textContent = "Processing…";
        const res = await fetch("/api/bulk", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || `HTTP ${res.status}`);
        }

        const blob = await res.blob();
        const cd = res.headers.get("content-disposition") || "";
        const m = cd.match(/filename="?([^"]+)"?/i);
        const filename = m ? m[1] : "mapbuddy_bulk.zip";

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        bulkStatus.textContent = "Done. Google Maps CSV is included in the ZIP.";
      } catch (err) {
        bulkStatus.textContent = `Error: ${err.message || err}`;
      }
    });

    // Initialize defaults
    setMode("single");
    // Preload a GMaps link if an ID is already filled (e.g., browser remembers)
    refreshGMapsLink();
  </script>
</body>
</html>
