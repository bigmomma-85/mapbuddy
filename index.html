<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>StormKML — Asset → KML Converter</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7fb; margin:0; padding:24px; }
      .card { max-width: 760px; margin: 0 auto; background:#fff; border:1px solid #e9ecf2; border-radius:12px; padding:24px; box-shadow:0 2px 10px rgba(0,0,0,0.03); }
      h1 { margin:0 0 8px; font-size: 28px; }
      p { margin: 0 0 16px; color:#445; }
      label { display:block; font-size:14px; color:#334; margin:12px 0 6px; }
      input, select, button { width:100%; padding:12px; font-size:16px; border:1px solid #cfd6e4; border-radius:8px; }
      button { background:#0b72ff; color:white; border:none; margin-top:16px; cursor:pointer; }
      button:disabled { background:#8fb6ff; cursor:not-allowed; }
      small { color:#667; }
      .row { display:grid; grid-template-columns: 1fr; gap:12px; }
      @media (min-width:720px) { .row { grid-template-columns: 2fr 1fr; } }
      #status { margin-top:12px; min-height:20px; color:#222; }
      #mapsLink { margin-top:10px; }
      .hint { margin-top:8px; color:#777; font-size:13px; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>StormKML — Asset → KML Converter</h1>
      <p>Enter an Asset / BMP ID, select a dataset, and download a KML generated from ArcGIS GeoJSON.</p>

      <div class="row">
        <div>
          <label for="asset">Asset / BMP ID</label>
          <input id="asset" placeholder="e.g., 1373DP, WP0399, 210049UT, FR12" />
          <div class="hint">Note: MDOT SHA layers require VPN.</div>
        </div>

        <div>
          <label for="dataset">Dataset</label>
          <select id="dataset" name="dataset" style="min-width: 420px">
            <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
            <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>

            <optgroup label="MDOT SHA — TMDL">
              <option value="mdsha_tmdl_any">MDOT SHA — TMDL (Auto-detect)</option>
              <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
              <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
              <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
              <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
              <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
              <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
            </optgroup>
          </select>
        </div>
      </div>

      <button id="go">Get KML</button>
      <div id="status"></div>
      <div id="mapsLink"></div>
      <small>Tip: Add more datasets in <code>api/convert.js</code> and <code>api/locate.js</code> later.</small>
    </div>

    <script>
      const btn = document.getElementById('go');
      const statusEl = document.getElementById('status');
      const mapsLinkEl = document.getElementById('mapsLink');
      const assetEl = document.getElementById('asset');
      const datasetEl = document.getElementById('dataset');

      async function locate(asset, dataset) {
        const r = await fetch('/api/locate', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ assetId: asset, dataset })
        });
        if (!r.ok) {
          let msg = `Locate failed (HTTP ${r.status})`;
          try { const err = await r.json(); if (err?.error) msg = err.error; } catch {}
          throw new Error(msg);
        }
        return r.json();
      }

      async function downloadKml(asset, dataset) {
        const resp = await fetch('/api/convert', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ assetId: asset, dataset })
        });

        if (!resp.ok) {
          let msg = `Request failed (HTTP ${resp.status})`;
          try {
            const err = await resp.json();
            if (err?.error) msg = err.error + (err?.details ? ` — ${err.details}` : '');
          } catch {
            try { msg += ' — ' + (await resp.text()).slice(0,160); } catch {}
          }
          throw new Error(msg);
        }

        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = asset + '.kml';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }

      async function handleClick() {
        const asset = assetEl.value.trim();
        const dataset = datasetEl.value;
        if (!asset) { statusEl.textContent = 'Please enter an Asset / BMP ID.'; return; }

        btn.disabled = true;
        statusEl.textContent = 'Locating…';
        mapsLinkEl.innerHTML = '';

        try {
          // 1) Get centroid + Google Maps link
          const info = await locate(asset, dataset);
          if (info?.googleMapsUrl && info?.centroid) {
            mapsLinkEl.innerHTML =
              `<a href="${info.googleMapsUrl}" target="_blank" rel="noopener">Open in Google Maps</a>` +
              ` &middot; <small>lat ${Number(info.centroid.lat).toFixed(6)}, lng ${Number(info.centroid.lng).toFixed(6)}</small>`;
          }

          // 2) Download the KML
          statusEl.textContent = 'Converting…';
          await downloadKml(asset, dataset);
          statusEl.textContent = 'KML downloaded.';
        } catch (e) {
          statusEl.textContent = e.message || 'Error';
        } finally {
          btn.disabled = false;
        }
      }

      btn.addEventListener('click', handleClick);
      assetEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleClick(); });
    </script>
  </body>
</html>
