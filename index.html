<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MapBuddy ‚Äî Asset ‚Üí KML / GeoJSON / Shapefile</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { mbBlue:'#2563eb', mbGreen:'#059669' },
          boxShadow: { card:'0 10px 30px rgba(2,6,23,.06)' }
        }
      }
    }
  </script>
  <style>
    .btn{ @apply inline-flex items-center justify-center font-semibold transition rounded-2xl px-5 py-3; }
    .btn-grad{ background:linear-gradient(90deg,#2563eb 0%,#059669 100%); color:#fff; }
    .btn-grad:hover{ filter:brightness(1.06); }
    .seg{ @apply inline-flex items-center gap-2 rounded-full px-4 py-2 border transition text-slate-600 bg-white; }
    .seg-active{ @apply text-white border-transparent; background:linear-gradient(90deg,#2563eb 0%,#059669 100%); }
    .seg:hover{ @apply border-slate-300; }
    .kbd{ @apply px-2 py-0.5 rounded border text-xs text-slate-600 bg-slate-50; }
    .card-radio{ @apply w-4 h-4 rounded-full border border-slate-300; }
    .card-radio.on{ @apply border-transparent; background:linear-gradient(90deg,#2563eb 0%,#059669 100%); }
  </style>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%232563eb' d='M6 10a4 4 0 0 1 4-4h4l8 3l8-3h4a4 4 0 0 1 4 4v24a4 4 0 0 1-4 4h-4l-8-3l-8 3h-4a4 4 0 0 1-4-4z'/%3E%3Cpath fill='%23059669' d='M14 6v32l8-3V3zM34 6v32l-8-3V3z'/%3E%3C/svg%3E" />
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-lg bg-gradient-to-r from-mbBlue to-mbGreen grid place-items-center shadow-sm">
            <svg width="18" height="18" viewBox="0 0 24 24" class="text-white">
              <path fill="currentColor" d="M9 20l-5.447-2.724A1 1 0 0 1 3 16.382V5.618a1 1 0 0 1 1.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0 0 21 18.382V7.618a1 1 0 0 0-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
          </div>
          <span class="font-bold text-xl text-slate-900">MapBuddy</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="px-4">
    <div class="max-w-6xl mx-auto pt-10 pb-4">
      <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 leading-tight">
        Convert Assets to <span class="bg-clip-text text-transparent bg-gradient-to-r from-mbBlue to-mbGreen">Map Files</span>
      </h1>
      <p class="mt-4 text-lg text-slate-600 max-w-3xl">
        Transform asset numbers into KML, GeoJSON, Shapefile. Single asset or bulk processing available.
      </p>

      <!-- Mode toggle -->
      <div class="mt-6">
        <div class="bg-white shadow-card inline-flex rounded-2xl p-1">
          <button id="tabSingle" class="px-6 py-2 rounded-xl bg-slate-100 text-slate-900">Single</button>
          <button id="tabBulk" class="px-6 py-2 rounded-xl text-slate-600 hover:text-slate-900">Bulk</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Single -->
  <section id="singlePane" class="px-4 mt-6">
    <div class="max-w-6xl mx-auto">
      <div class="bg-white shadow-card rounded-2xl p-6 md:p-8">
        <div class="grid md:grid-cols-3 gap-5">
          <!-- Asset -->
          <div class="space-y-2">
            <label class="block text-sm font-medium text-slate-700">Asset / BMP ID</label>
            <input id="singleAsset" placeholder="e.g., WP0399, 210049UT, LOD_12345" class="w-full rounded-xl border p-3 focus:outline-none focus:ring-2 focus:ring-mbBlue" />
          </div>

          <!-- Dataset -->
          <div class="space-y-2">
            <label class="block text-sm font-medium text-slate-700">Dataset</label>
            <select id="singleDataset" class="w-full rounded-xl border p-3 bg-white focus:outline-none focus:ring-2 focus:ring-mbBlue">
              <optgroup label="Fairfax">
                <option value="fairfax_bmps">Fairfax ‚Äî Stormwater Facilities (FACILITY_ID)</option>
              </optgroup>
              <optgroup label="MDOT SHA">
                <option value="mdsha_landscape">MDOT SHA ‚Äî Managed Landscape (LOD_ID)</option>
              </optgroup>
              <optgroup label="MDOT SHA ‚Äî TMDL">
                <option value="mdsha_tmdl_structures">TMDL ‚Äî Stormwater Control Structures</option>
                <option value="mdsha_tmdl_retrofits">TMDL ‚Äî Retrofits</option>
                <option value="mdsha_tmdl_tree_plantings">TMDL ‚Äî Tree Plantings</option>
                <option value="mdsha_tmdl_pavement_removals">TMDL ‚Äî Pavement Removals</option>
                <option value="mdsha_tmdl_stream_restorations">TMDL ‚Äî Stream Restorations</option>
                <option value="mdsha_tmdl_outfall_stabilizations">TMDL ‚Äî Outfall Stabilizations</option>
              </optgroup>
            </select>
          </div>

          <!-- Format (segmented) -->
          <div class="space-y-2">
            <label class="block text-sm font-medium text-slate-700">Format</label>
            <div class="flex gap-2">
              <button class="seg" data-format="kml">üó∫Ô∏è KML</button>
              <button class="seg" data-format="geojson">üìä GeoJSON</button>
              <button class="seg" data-format="shapefile">üóÉÔ∏è Shapefile</button>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-6 flex flex-wrap items-center gap-4">
          <button id="singleGo" class="btn btn-grad">Download</button>

          <div id="linkRow" class="hidden items-center gap-3">
            <a id="mapsLink" target="_blank" class="text-mbBlue hover:underline">Open in Google Maps ‚Üí</a>
            <button id="copyLink" class="btn btn-grad">Copy link</button>
          </div>

          <span class="ml-auto text-sm text-slate-500">
            <span class="px-2 py-0.5 rounded-full bg-slate-100 border text-slate-700">Note</span>
            MDOT SHA layers may require VPN.
          </span>
        </div>

        <p id="singleStatus" class="mt-3 text-sm text-slate-600"></p>
      </div>
    </div>
  </section>

  <!-- Bulk -->
  <section id="bulkPane" class="px-4 mt-6 hidden">
    <div class="max-w-6xl mx-auto">
      <div class="bg-white shadow-card rounded-2xl p-6 md:p-8">
        <h3 class="text-2xl font-bold text-slate-900 mb-6 text-center">Bulk Asset Conversion</h3>

        <div class="grid md:grid-cols-2 gap-8">
          <!-- Left column: dataset + CSV drop -->
          <div class="space-y-6">
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-slate-700">Dataset</label>
              <select id="bulkDataset" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-mbBlue focus:border-transparent">
                <optgroup label="Fairfax">
                  <option value="fairfax_bmps">Fairfax ‚Äî Stormwater Facilities (FACILITY_ID)</option>
                </optgroup>
                <optgroup label="MDOT SHA">
                  <option value="mdsha_landscape">MDOT SHA ‚Äî Managed Landscape (LOD_ID)</option>
                </optgroup>
                <optgroup label="MDOT SHA ‚Äî TMDL">
                  <option value="mdsha_tmdl_structures">TMDL ‚Äî Stormwater Control Structures</option>
                  <option value="mdsha_tmdl_retrofits">TMDL ‚Äî Retrofits</option>
                  <option value="mdsha_tmdl_tree_plantings">TMDL ‚Äî Tree Plantings</option>
                  <option value="mdsha_tmdl_pavement_removals">TMDL ‚Äî Pavement Removals</option>
                  <option value="mdsha_tmdl_stream_restorations">TMDL ‚Äî Stream Restorations</option>
                  <option value="mdsha_tmdl_outfall_stabilizations">TMDL ‚Äî Outfall Stabilizations</option>
                </optgroup>
              </select>
            </div>

            <!-- Drop zone -->
            <div id="csvDrop" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-mbBlue transition-colors cursor-pointer">
              <div class="flex flex-col items-center">
                <div class="w-12 h-12 bg-gradient-to-r from-mbBlue to-mbGreen rounded-full flex items-center justify-center mb-4">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                  </svg>
                </div>
                <h4 class="text-lg font-semibold text-gray-900 mb-1">Drop your CSV file here</h4>
                <p class="text-gray-500 mb-4">or click to browse</p>
                <button id="csvChooseBtn" class="btn btn-grad">Choose CSV File</button>
                <input id="bulkFile" type="file" accept=".csv" class="hidden" />
              </div>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h5 class="font-semibold text-blue-900 mb-2">CSV Format Requirements:</h5>
              <ul class="text-sm text-blue-800 space-y-1">
                <li>‚Ä¢ First column: Asset numbers</li>
                <li>‚Ä¢ Header row required</li>
                <li>‚Ä¢ Maximum 1000 assets per file</li>
              </ul>
            </div>
          </div>

          <!-- Right column: output format cards -->
          <div class="space-y-4">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Output Formats</label>

            <button class="w-full text-left p-4 rounded-xl border hover:border-mbGreen transition flex items-start gap-4" data-bulkfmt="kmlzip">
              <span class="mt-1 card-radio"></span>
              <div>
                <div class="font-semibold text-slate-900 flex items-center gap-2">üó∫Ô∏è KML Files</div>
                <div class="text-sm text-slate-500">Google Earth format</div>
              </div>
            </button>

            <button class="w-full text-left p-4 rounded-xl border hover:border-mbGreen transition flex items-start gap-4" data-bulkfmt="geojsonzip">
              <span class="mt-1 card-radio"></span>
              <div>
                <div class="font-semibold text-slate-900 flex items-center gap-2">üìä GeoJSON Files</div>
                <div class="text-sm text-slate-500">Web mapping format</div>
              </div>
            </button>

            <button class="w-full text-left p-4 rounded-xl border hover:border-mbGreen transition flex items-start gap-4" data-bulkfmt="shpzip">
              <span class="mt-1 card-radio"></span>
              <div>
                <div class="font-semibold text-slate-900 flex items-center gap-2">üóÉÔ∏è Shapefile</div>
                <div class="text-sm text-slate-500">GIS standard format</div>
              </div>
            </button>

            <div class="w-full text-left p-4 rounded-xl border bg-slate-50 flex items-start gap-4 opacity-90">
              <span class="mt-1 card-radio on"></span>
              <div>
                <div class="font-semibold text-slate-900 flex items-center gap-2">üåê Google Maps Links</div>
                <div class="text-sm text-slate-500">Direct map links (CSV) ‚Äî included with bulk</div>
              </div>
            </div>
          </div>
        </div>

        <div class="text-center mt-8">
          <button id="bulkGo" class="btn btn-grad">Process Bulk Conversion</button>
        </div>

        <p id="bulkStatus" class="mt-4 text-sm text-slate-600 text-center"></p>
      </div>
    </div>
  </section>

  <footer class="py-10 text-center text-slate-400 text-sm">
    ¬© 2025 MapBuddy ¬∑ Simple, reliable asset-to-map conversion.
  </footer>

  <script>
    // Mode switching
    const tabSingle = document.getElementById('tabSingle');
    const tabBulk   = document.getElementById('tabBulk');
    const singlePane= document.getElementById('singlePane');
    const bulkPane  = document.getElementById('bulkPane');
    const setTab = (single=true) => {
      if (single) {
        tabSingle.classList.add('bg-slate-100','text-slate-900');
        tabBulk.classList.remove('bg-slate-100','text-slate-900');
        singlePane.classList.remove('hidden');
        bulkPane.classList.add('hidden');
      } else {
        tabBulk.classList.add('bg-slate-100','text-slate-900');
        tabSingle.classList.remove('bg-slate-100','text-slate-900');
        bulkPane.classList.remove('hidden');
        singlePane.classList.add('hidden');
      }
    }
    tabSingle.onclick = () => setTab(true);
    tabBulk.onclick   = () => setTab(false);
    setTab(true);

    // Single segmented selector
    const segBtns = document.querySelectorAll('[data-format]');
    let selectedFormat = localStorage.getItem('mb.formatSeg') || 'kml';
    function renderSeg(){
      segBtns.forEach(b=>{
        if(b.dataset.format===selectedFormat){ b.classList.add('seg-active'); b.classList.remove('border'); }
        else { b.classList.remove('seg-active'); b.classList.add('border'); }
      });
    }
    segBtns.forEach(b=>b.addEventListener('click',()=>{ selectedFormat=b.dataset.format; localStorage.setItem('mb.formatSeg',selectedFormat); renderSeg(); }));
    renderSeg();

    // Persist dataset choices
    function savePrefs(){
      localStorage.setItem('mb.dataset', document.getElementById('singleDataset').value);
      localStorage.setItem('mb.bulkDataset', document.getElementById('bulkDataset').value);
      localStorage.setItem('mb.bulkFmt', bulkFmt);
    }
    function loadPrefs(){
      const d=localStorage.getItem('mb.dataset');
      const bd=localStorage.getItem('mb.bulkDataset');
      const bf=localStorage.getItem('mb.bulkFmt');
      if(d) document.getElementById('singleDataset').value=d;
      if(bd) document.getElementById('bulkDataset').value=bd;
      if(bf) bulkFmt=bf;
      renderBulkCards();
    }

    // API helpers
    async function locate(assetId, dataset){
      const r=await fetch('/api/locate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({assetId,dataset})});
      if(!r.ok) throw new Error(`Locate failed (HTTP ${r.status})`);
      return r.json();
    }
    async function convert(assetId, dataset, format){
      const r=await fetch('/api/convert',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({assetId,dataset,format})});
      if(!r.ok){ let msg=`Request failed (HTTP ${r.status})`; try{const e=await r.json(); if(e?.error) msg=e.error;}catch{} throw new Error(msg);}
      return r.blob();
    }
    function downloadBlob(filename, blob){
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Single flow
    const singleAsset   = document.getElementById('singleAsset');
    const singleDataset = document.getElementById('singleDataset');
    const singleGo      = document.getElementById('singleGo');
    const singleStatus  = document.getElementById('singleStatus');
    const mapsLink      = document.getElementById('mapsLink');
    const copyLinkBtn   = document.getElementById('copyLink');
    const linkRow       = document.getElementById('linkRow');

    singleDataset.addEventListener('change', savePrefs);

    singleGo.onclick = async () => {
      const asset = singleAsset.value.trim();
      const dataset = singleDataset.value;
      const format = selectedFormat; // 'kml'|'geojson'|'shapefile'
      if(!asset){ singleStatus.textContent='Please enter an Asset / BMP ID.'; return; }

      singleGo.disabled=true; singleStatus.textContent='Locating‚Ä¶'; linkRow.classList.add('hidden');

      try{
        const info=await locate(asset,dataset);
        if(info?.googleMapsUrl){
          mapsLink.href=info.googleMapsUrl;
          linkRow.classList.remove('hidden');
          copyLinkBtn.onclick=async()=>{ try{ await navigator.clipboard.writeText(info.googleMapsUrl); singleStatus.textContent='Copied Google Maps link.'; }catch{ singleStatus.textContent='Copy failed.'; } }
        }
        singleStatus.textContent='Converting‚Ä¶';
        const blob=await convert(asset,dataset,format);
        const ext=(format==='kml')?'kml':(format==='geojson')?'geojson':'zip';
        downloadBlob(`${asset}.${ext}`,blob);
        singleStatus.textContent='Done.';
      }catch(e){ singleStatus.textContent=e.message||'Error'; }
      finally{ singleGo.disabled=false; }
    };

    // Bulk: CSV drop + format cards
    const csvDrop       = document.getElementById('csvDrop');
    const csvChooseBtn  = document.getElementById('csvChooseBtn');
    const bulkFile      = document.getElementById('bulkFile');
    const bulkDataset   = document.getElementById('bulkDataset');
    const bulkGo        = document.getElementById('bulkGo');
    const bulkStatus    = document.getElementById('bulkStatus');

    let csvText='';
    function markCsvOK(){
      csvDrop.classList.remove('border-gray-300');
      csvDrop.classList.add('border-mbGreen','bg-green-50');
      csvDrop.querySelector('h4').textContent='CSV uploaded successfully!';
      csvDrop.querySelector('p').textContent='Ready to process';
      savePrefs();
    }
    function handleFile(f){
      if(!f) return;
      f.text().then(t=>{ csvText=t.trim(); if(csvText) markCsvOK(); });
    }
    csvDrop.addEventListener('dragover',e=>{ e.preventDefault(); csvDrop.classList.add('border-mbBlue','bg-blue-50'); });
    csvDrop.addEventListener('dragleave',()=>{ csvDrop.classList.remove('border-mbBlue','bg-blue-50'); });
    csvDrop.addEventListener('drop',e=>{ e.preventDefault(); csvDrop.classList.remove('border-mbBlue','bg-blue-50'); handleFile(e.dataTransfer.files?.[0]); });
    csvDrop.addEventListener('click',()=> bulkFile.click());
    csvChooseBtn.addEventListener('click',e=>{ e.stopPropagation(); bulkFile.click(); });
    bulkFile.addEventListener('change',e=> handleFile(e.target.files?.[0]) );

    // Bulk format cards (exclusive)
    const bulkFmtButtons = document.querySelectorAll('[data-bulkfmt]');
    let bulkFmt='kmlzip';
    function renderBulkCards(){
      bulkFmtButtons.forEach(b=>{
        const radio=b.querySelector('.card-radio');
        if(b.dataset.bulkfmt===bulkFmt){
          b.classList.add('border-mbGreen','bg-green-50');
          radio.classList.add('on');
        }else{
          b.classList.remove('border-mbGreen','bg-green-50');
          radio.classList.remove('on');
        }
      });
    }
    bulkFmtButtons.forEach(b=> b.addEventListener('click',()=>{ bulkFmt=b.dataset.bulkfmt; renderBulkCards(); savePrefs(); }));
    renderBulkCards();
    bulkDataset.addEventListener('change', savePrefs);
    loadPrefs();

    function parseCsvToItems(text, defaultDataset){
      const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(!lines.length) return [];
      const first=lines[0].split(',').map(s=>s.trim());
      let i0=0; if(first[0].toLowerCase().includes('asset')) i0=1;
      const items=[];
      for(let i=i0;i<lines.length;i++){
        const cols=lines[i].split(',').map(s=>s.trim()).filter(Boolean);
        if(!cols.length) continue;
        const assetId=cols[0];
        const dataset=(cols[1]&&cols[1]!=='-')?cols[1]:defaultDataset;
        if(assetId) items.push({assetId,dataset});
      }
      return items;
    }

    async function bulkConvert(payload){
      const r=await fetch('/api/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok){ let msg=`Bulk failed (HTTP ${r.status})`; try{const e=await r.json(); if(e?.error) msg=e.error;}catch{} throw new Error(msg); }
      return r.blob();
    }

    bulkGo.onclick = async ()=>{
      if(!csvText){ bulkStatus.textContent='Please upload a CSV file.'; return; }
      const items=parseCsvToItems(csvText, bulkDataset.value);
      if(!items.length){ bulkStatus.textContent='No parsable rows found.'; return; }

      bulkGo.disabled=true; bulkStatus.textContent=`Processing ${items.length} item(s)‚Ä¶`;
      try{
        const blob=await bulkConvert({ items, defaultDataset: bulkDataset.value, format: bulkFmt });
        const name= bulkFmt==='kmlzip' ? 'mapbuddy_kml.zip' : bulkFmt==='geojsonzip' ? 'mapbuddy_geojson.zip' : 'mapbuddy_shapefile.zip';
        downloadBlob(name, blob);
        bulkStatus.textContent='Done. (mapbuddy_links.csv included)';
      }catch(e){ bulkStatus.textContent=e.message||'Error'; }
      finally{ bulkGo.disabled=false; }
    };
  </script>
</body>
</html>
