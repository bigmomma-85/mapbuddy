<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MapBuddy ‚Äî Convert Assets to Map Files</title>

  <!-- Tailwind (CDN build) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mbBlue: '#2563eb',
            mbGreen: '#059669',
            mbDark: '#0f172a'
          },
          boxShadow: {
            card: '0 8px 24px rgba(15, 23, 42, .08)'
          }
        }
      }
    }
  </script>

  <style>
    /* pill radio/checkbox cards */
    .pill {
      @apply flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 transition
             hover:border-slate-300 cursor-pointer shadow-sm;
    }
    .pill[data-active="true"] {
      @apply border-emerald-300 bg-emerald-50;
    }
    /* gradient primary button */
    .btn-primary {
      @apply rounded-xl px-5 py-3 font-semibold text-white shadow-md
             bg-gradient-to-r from-mbBlue to-mbGreen hover:opacity-95 active:opacity-90;
    }
    /* soft secondary button */
    .btn-soft {
      @apply rounded-xl px-4 py-3 font-medium text-slate-700 bg-slate-100 hover:bg-slate-200;
    }
    /* blue link button (for inline actions) */
    .btn-link {
      @apply rounded-xl px-3 py-2 font-medium text-white bg-mbBlue/90 hover:bg-mbBlue;
    }
    /* dashed dropzone */
    .dropzone {
      @apply border-2 border-dashed border-slate-300 rounded-2xl bg-white/60 p-8 text-center
             hover:border-mbBlue transition;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-blue-50">

  <!-- Header -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-100">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-lg bg-gradient-to-r from-mbBlue to-mbGreen grid place-items-center shadow">
        <svg viewBox="0 0 24 24" class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 7l6-3 6 3 6-3v13l-6 3-6-3-6 3V7z"/>
        </svg>
      </div>
      <div class="text-lg font-semibold text-slate-900">MapBuddy</div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-6xl mx-auto px-4 pt-10 pb-6">
    <h1 class="text-4xl sm:text-5xl font-extrabold text-slate-900 tracking-tight">
      Convert Assets to
      <span class="bg-gradient-to-r from-mbBlue to-mbGreen bg-clip-text text-transparent">Map Files</span>
    </h1>
    <p class="mt-4 text-lg text-slate-600 max-w-3xl">
      Transform asset numbers into KML, GeoJSON, Shapefile. Single asset or bulk processing available.
    </p>
  </section>

  <!-- Mode Toggle -->
  <section class="max-w-6xl mx-auto px-4">
    <div class="w-fit bg-white rounded-2xl p-1 shadow-card border border-slate-100">
      <button id="tabSingle" class="px-6 py-2 rounded-xl font-medium text-white bg-gradient-to-r from-mbBlue to-mbGreen">
        Single
      </button>
      <button id="tabBulk" class="px-6 py-2 rounded-xl font-medium text-slate-700 hover:bg-slate-100">
        Bulk
      </button>
    </div>
  </section>

  <!-- Single Card -->
  <section id="panelSingle" class="max-w-6xl mx-auto px-4 mt-6">
    <div class="rounded-3xl bg-white shadow-card border border-slate-100 p-6">
      <div class="grid lg:grid-cols-3 gap-4 items-end">
        <!-- Asset -->
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">Asset / BMP ID</label>
          <input id="singleAsset" class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-mbBlue"
                 placeholder="e.g., WP0399, 210049UT, LOD_12345" />
        </div>

        <!-- Dataset -->
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">Dataset</label>
          <select id="singleDataset" class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-mbBlue">
            <!-- options injected by JS -->
          </select>
        </div>

        <!-- Format (pills) -->
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">Format</label>
          <div id="singleFormat" class="flex flex-wrap gap-2">
            <!-- radio pills injected by JS -->
          </div>
        </div>
      </div>

      <div class="mt-5 flex flex-wrap items-center gap-3">
        <button id="btnSingleDownload" class="btn-primary">Download</button>
        <a id="gmLink" href="#" target="_blank" rel="noopener" class="btn-link hidden">Open in Google Maps ‚Üí</a>
        <button id="btnCopy" class="btn-soft hidden">Copy link</button>

        <span id="singleNote" class="ml-auto text-sm text-slate-500">
          <span class="rounded-full bg-slate-100 px-3 py-1 mr-2">Note</span>
          MDOT SHA layers may require VPN.
        </span>
      </div>

      <div id="singleStatus" class="mt-3 text-sm text-slate-600">Done.</div>
    </div>
  </section>

  <!-- Bulk Card -->
  <section id="panelBulk" class="max-w-6xl mx-auto px-4 mt-6 hidden">
    <div class="rounded-3xl bg-white shadow-card border border-slate-100 p-6">
      <h3 class="text-xl font-bold text-slate-900 mb-4">Bulk Asset Conversion</h3>

      <div class="grid lg:grid-cols-2 gap-6">
        <!-- Left: dataset + dropzone + tips -->
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">Dataset</label>
          <select id="bulkDataset" class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-mbBlue mb-4">
            <!-- options injected by JS -->
          </select>

          <!-- Dropzone -->
          <div id="dz" class="dropzone">
            <div class="flex flex-col items-center">
              <div class="w-12 h-12 rounded-full bg-gradient-to-r from-mbBlue to-mbGreen grid place-items-center text-white shadow mb-3">
                <svg viewBox="0 0 24 24" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.9-7.9A5 5 0 1116 6a5 5 0 11.9 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
              </div>
              <div class="font-semibold text-slate-900">Drop your CSV file here</div>
              <div class="text-slate-500 mt-1">or click to browse</div>
              <input id="fileInput" type="file" accept=".csv" class="hidden"/>
              <button id="btnChooseCsv" class="btn-primary mt-3">Choose CSV File</button>
            </div>
          </div>

          <!-- CSV Requirements -->
          <div class="mt-4 rounded-xl border border-blue-200 bg-blue-50 p-4">
            <div class="font-semibold text-blue-900 mb-1">CSV Format Requirements:</div>
            <ul class="text-sm text-blue-800 space-y-1">
              <li>‚Ä¢ First column: Asset numbers</li>
              <li>‚Ä¢ Header row optional</li>
              <li>‚Ä¢ Up to 1000 assets per file</li>
              <li>‚Ä¢ Optional second column: dataset key</li>
            </ul>
          </div>
        </div>

        <!-- Right: output formats (pill radios) -->
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">Output Formats</label>
          <div id="bulkFormats" class="space-y-3">
            <!-- format cards injected by JS -->
          </div>

          <div class="mt-3 rounded-xl border border-slate-200 bg-slate-50 p-3 text-sm text-slate-700">
            <div class="font-medium">Google Maps Links</div>
            <div>Direct map links (CSV) ‚Äî included with bulk.</div>
          </div>
        </div>
      </div>

      <div class="mt-6">
        <button id="btnProcess" class="btn-primary">Process Bulk Conversion</button>
        <div id="bulkStatus" class="inline-block ml-3 text-sm text-slate-600 align-middle"></div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="max-w-6xl mx-auto px-4 py-10 text-center text-slate-500">
    ¬© 2025 MapBuddy ¬∑ Simple, reliable asset-to-map conversion.
  </footer>

  <!-- Logic -->
  <script>
    // ---------- dataset options ----------
    const DATASETS = [
      { value: 'fairfax_bmps', label: 'Fairfax ‚Äî Stormwater Facilities (FACILITY_ID)' },
      { value: 'mdsha_landscape', label: 'MDOT SHA ‚Äî Managed Landscape (LOD_ID)' },
      { value: 'mdsha_tmdl_any', label: 'MDOT SHA ‚Äî TMDL (Auto-detect)' },
      { value: 'mdsha_tmdl_structures', label: 'MDOT SHA ‚Äî TMDL ‚Äî Stormwater Control Structures' },
      { value: 'mdsha_tmdl_retrofits', label: 'MDOT SHA ‚Äî TMDL ‚Äî Retrofits' },
      { value: 'mdsha_tmdl_trees', label: 'MDOT SHA ‚Äî TMDL ‚Äî Tree Plantings' },
      { value: 'mdsha_tmdl_pavement', label: 'MDOT SHA ‚Äî TMDL ‚Äî Pavement Removals' },
      { value: 'mdsha_tmdl_streams', label: 'MDOT SHA ‚Äî TMDL ‚Äî Stream Restorations' },
      { value: 'mdsha_tmdl_outfalls', label: 'MDOT SHA ‚Äî TMDL ‚Äî Outfall Stabilizations' },
    ];

    // formats (single = choose one)
    const SINGLE_FORMATS = [
      { value: 'kml',   label: 'üó∫Ô∏è KML' },
      { value: 'geojson', label: 'üìä GeoJSON' },
      { value: 'shpzip',  label: 'üóÉÔ∏è Shapefile (.zip)' },
    ];
    // bulk (choose one) mapping to server zip flavors
    const BULK_FORMATS = [
      { value: 'kmlzip',   title: 'üó∫Ô∏è KML Files', desc: 'Google Earth format' },
      { value: 'geojsonzip', title: 'üìä GeoJSON Files', desc: 'Web mapping format' },
      { value: 'shpzip',     title: 'üóÉÔ∏è Shapefile', desc: 'GIS standard format' },
    ];

    // ---------- DOM refs ----------
    const tabSingle = document.getElementById('tabSingle');
    const tabBulk   = document.getElementById('tabBulk');
    const panelSingle = document.getElementById('panelSingle');
    const panelBulk   = document.getElementById('panelBulk');

    const singleAsset   = document.getElementById('singleAsset');
    const singleDataset = document.getElementById('singleDataset');
    const singleFormatWrap = document.getElementById('singleFormat');
    const btnSingleDownload = document.getElementById('btnSingleDownload');
    const gmLink = document.getElementById('gmLink');
    const btnCopy = document.getElementById('btnCopy');
    const singleStatus = document.getElementById('singleStatus');

    const bulkDataset = document.getElementById('bulkDataset');
    const bulkFormatsWrap = document.getElementById('bulkFormats');
    const btnProcess = document.getElementById('btnProcess');
    const bulkStatus = document.getElementById('bulkStatus');

    const dz = document.getElementById('dz');
    const fileInput = document.getElementById('fileInput');
    const btnChooseCsv = document.getElementById('btnChooseCsv');

    // ---------- helpers ----------
    function renderSelect(el, options) {
      el.innerHTML = options.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
    }
    function renderRadioPills(container, name, items, initialValue) {
      container.innerHTML = items.map(i => {
        const active = i.value === initialValue;
        return `
          <label class="pill" data-active="${active}" data-value="${i.value}">
            <input type="radio" name="${name}" value="${i.value}" class="hidden" ${active ? 'checked' : ''}/>
            <span>${i.label}</span>
          </label>
        `;
      }).join('');
      container.querySelectorAll('label.pill').forEach(lbl => {
        lbl.addEventListener('click', () => {
          container.querySelectorAll('label.pill').forEach(x => x.dataset.active = 'false');
          lbl.dataset.active = 'true';
          const r = lbl.querySelector('input[type="radio"]');
          if (r) r.checked = true;
        });
      });
    }
    function renderBulkFormatCards(container, name, items, initialValue) {
      container.innerHTML = items.map(i => {
        const active = i.value === initialValue;
        return `
          <label class="pill justify-between" data-active="${active}" data-value="${i.value}">
            <div class="flex items-center gap-2">
              <input type="radio" name="${name}" value="${i.value}" class="hidden" ${active ? 'checked' : ''}/>
              <div class="font-medium">${i.title}</div>
            </div>
            <div class="text-sm text-slate-500">${i.desc}</div>
          </label>
        `;
      }).join('');
      container.querySelectorAll('label.pill').forEach(lbl => {
        lbl.addEventListener('click', () => {
          container.querySelectorAll('label.pill').forEach(x => x.dataset.active = 'false');
          lbl.dataset.active = 'true';
          const r = lbl.querySelector('input[type="radio"]');
          if (r) r.checked = true;
        });
      });
    }
    function currentRadioValue(container) {
      const r = container.querySelector('input[type="radio"]:checked');
      return r ? r.value : null;
    }

    // ---------- init ----------
    renderSelect(singleDataset, DATASETS);
    renderSelect(bulkDataset, DATASETS);
    renderRadioPills(singleFormatWrap, 'singleFmt', SINGLE_FORMATS, 'kml');
    renderBulkFormatCards(bulkFormatsWrap, 'bulkFmt', BULK_FORMATS, 'kmlzip');

    // tabs
    function activate(tab) {
      if (tab === 'single') {
        tabSingle.className = 'px-6 py-2 rounded-xl font-medium text-white bg-gradient-to-r from-mbBlue to-mbGreen';
        tabBulk.className   = 'px-6 py-2 rounded-xl font-medium text-slate-700 hover:bg-slate-100';
        panelSingle.classList.remove('hidden');
        panelBulk.classList.add('hidden');
      } else {
        tabBulk.className   = 'px-6 py-2 rounded-xl font-medium text-white bg-gradient-to-r from-mbBlue to-mbGreen';
        tabSingle.className = 'px-6 py-2 rounded-xl font-medium text-slate-700 hover:bg-slate-100';
        panelBulk.classList.remove('hidden');
        panelSingle.classList.add('hidden');
      }
    }
    tabSingle.addEventListener('click', () => activate('single'));
    tabBulk.addEventListener('click',   () => activate('bulk'));

    // ---------- Single: locate + download ----------
    async function locate(assetId, dataset) {
      const r = await fetch('/api/locate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ assetId, dataset })
      });
      if (!r.ok) throw new Error(`Locate failed (HTTP ${r.status})`);
      return r.json();
    }
    async function convertSingle(assetId, dataset, format) {
      const r = await fetch('/api/convert', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ assetId, dataset, format })
      });
      if (!r.ok) {
        let msg = `Request failed (HTTP ${r.status})`;
        try { const e = await r.json(); if (e?.error) msg = e.error; } catch {}
        throw new Error(msg);
      }
      return r.blob();
    }
    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    btnSingleDownload.addEventListener('click', async () => {
      const assetId = singleAsset.value.trim();
      const dataset = singleDataset.value;
      const format  = currentRadioValue(singleFormatWrap) || 'kml';
      if (!assetId) {
        singleStatus.textContent = 'Please enter an Asset / BMP ID.';
        return;
      }

      btnSingleDownload.disabled = true;
      btnSingleDownload.textContent = 'Working‚Ä¶';
      singleStatus.textContent = 'Locating‚Ä¶';
      gmLink.classList.add('hidden');
      btnCopy.classList.add('hidden');

      try {
        // locate for GMaps
        const info = await locate(assetId, dataset);
        if (info?.googleMapsUrl) {
          gmLink.href = info.googleMapsUrl;
          gmLink.classList.remove('hidden');
          btnCopy.classList.remove('hidden');
          btnCopy.onclick = () => navigator.clipboard.writeText(info.googleMapsUrl);
        }

        // convert
        singleStatus.textContent = 'Converting‚Ä¶';
        const blob = await convertSingle(assetId, dataset, format);
        const ext = format === 'kml' ? '.kml' : (format === 'geojson' ? '.geojson' : '.zip');
        downloadBlob(blob, `${assetId}${ext}`);
        singleStatus.textContent = 'Done.';
      } catch (e) {
        singleStatus.textContent = e.message || 'Error';
      } finally {
        btnSingleDownload.disabled = false;
        btnSingleDownload.textContent = 'Download';
      }
    });

    // ---------- Bulk: dropzone + process ----------
    dz.addEventListener('click', () => fileInput.click());
    btnChooseCsv.addEventListener('click', () => fileInput.click());

    let bulkCsvText = '';
    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      bulkStatus.textContent = 'Reading CSV‚Ä¶';
      bulkCsvText = await f.text();
      bulkStatus.textContent = 'CSV ready.';
    });

    function parseCsvToItems(text) {
      // Accepts: "assetId" OR "assetId,dataset"
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      if (!lines.length) return [];
      // If header, drop first line if it contains non-ID-ish text
      const maybeHeader = lines[0].toLowerCase();
      const startIdx = /asset|id|dataset/.test(maybeHeader) ? 1 : 0;

      const items = [];
      for (let i = startIdx; i < lines.length; i++) {
        const parts = lines[i].split(',').map(s => s.trim());
        if (!parts[0]) continue;
        const row = { assetId: parts[0] };
        if (parts[1]) row.dataset = parts[1];
        items.push(row);
      }
      return items;
    }

    async function bulkConvert(items, defaultDataset, format) {
      const r = await fetch('/api/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items, defaultDataset, format })
      });
      if (!r.ok) {
        let msg = `Bulk failed (HTTP ${r.status})`;
        try { const e = await r.json(); if (e?.error) msg = e.error; } catch {}
        throw new Error(msg);
      }
      return r.blob(); // should be a .zip
    }

    btnProcess.addEventListener('click', async () => {
      const format = currentRadioValue(bulkFormatsWrap) || 'kmlzip';
      const defaultDataset = bulkDataset.value;

      if (!bulkCsvText) {
        bulkStatus.textContent = 'Please choose a CSV first.';
        return;
      }
      const items = parseCsvToItems(bulkCsvText);
      if (!items.length) {
        bulkStatus.textContent = 'No valid rows found in CSV.';
        return;
      }

      btnProcess.disabled = true;
      btnProcess.textContent = 'Processing‚Ä¶';
      bulkStatus.textContent = `Converting ${items.length} assets‚Ä¶`;

      try {
        const blob = await bulkConvert(items, defaultDataset, format);
        const name = format === 'kmlzip' ? 'mapbuddy_kml.zip'
                    : format === 'geojsonzip' ? 'mapbuddy_geojson.zip'
                    : 'mapbuddy_shapefile.zip';
        downloadBlob(blob, name);
        bulkStatus.textContent = 'Done. (Includes mapbuddy_links.csv)';
      } catch (e) {
        bulkStatus.textContent = e.message || 'Error';
      } finally {
        btnProcess.disabled = false;
        btnProcess.textContent = 'Process Bulk Conversion';
      }
    });
  </script>
</body>
</html>
