<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MapBuddy — Asset → KML / GeoJSON / Shapefile / Map PDF</title>
    <style>
      :root{
        --bg1:#eef6f7; --bg2:#ffffff;
        --text:#0f172a; --muted:#475569;
        --brand:#0b72ff; --brand-2:#0aa86d;
        --ring:rgba(11,114,255,.25);
        --card:#ffffff; --line:#e5eaf1;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; color:var(--text); background:
          radial-gradient(1200px 600px at 20% -10%, #e6f3ff 0%, transparent 60%),
          radial-gradient(1000px 700px at 120% -20%, #e8fff5 0%, transparent 60%),
          linear-gradient(180deg,var(--bg1),var(--bg2));
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      }
      .wrap{max-width:1100px; margin:0 auto; padding:48px 20px 64px}
      h1{font-size:44px; line-height:1.1; margin:0 0 10px; letter-spacing:.2px}
      .sub{color:var(--muted); margin:0 0 28px}

      .tabs{
        display:flex; gap:12px; align-items:center;
        position:sticky; top:0; padding:10px 0 0; margin:4px 0 16px;
      }
      .tab{
        border:1px solid var(--line);
        background:#0f172a; color:#fff;
        padding:8px 22px; border-radius:999px; cursor:pointer;
        opacity:.55; transition:.2s;
      }
      .tab:not(.active){background:#f8fafc; color:#0f172a}
      .tab.active{opacity:1; box-shadow:0 6px 18px rgba(0,0,0,.08)}

      .card{
        background:var(--card); border:1px solid var(--line);
        border-radius:16px; padding:18px; box-shadow:0 8px 24px rgba(15,23,42,.06);
      }
      .grid{display:grid; grid-template-columns:1.2fr 1.1fr .8fr; gap:14px}
      @media (max-width:980px){ .grid{grid-template-columns:1fr} }

      label{display:block; font-size:13px; color:#263041; margin:6px 0 6px}
      input,select{
        width:100%; padding:14px 14px; font-size:16px;
        background:#fff; border:1px solid var(--line); border-radius:12px;
        outline:0; transition:.15s;
      }
      input:focus,select:focus{border-color:#bcd3ff; box-shadow:0 0 0 6px var(--ring)}

      .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
      .btn{
        display:inline-flex; align-items:center; justify-content:center;
        padding:14px 22px; border-radius:12px; cursor:pointer; user-select:none;
        border:0; color:#fff; background:var(--brand);
        font-size:16px; font-weight:600; min-width:200px;
        box-shadow:0 10px 24px rgba(11,114,255,.22); transition:.18s;
      }
      .btn:disabled{opacity:.55; cursor:not-allowed; box-shadow:none}
      .btn.green{background:var(--brand-2); box-shadow:0 10px 24px rgba(10,168,109,.22)}
      .btn.sm{min-width:unset; padding:10px 14px; font-size:14px}
      .link{color:var(--brand); text-decoration:none}
      .muted{color:var(--muted)}
      .note{display:inline-flex; align-items:center; gap:10px; border:1px solid var(--line); border-radius:28px; padding:6px 12px}
      .status{min-height:22px}

      .bulk-grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
      .bulk-rows{height:260px; width:100%; padding:14px; font-size:15px; border-radius:12px; border:1px solid var(--line); resize:vertical}
      @media (max-width:980px){ .bulk-grid{grid-template-columns:1fr} .btn{min-width:160px} }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>MapBuddy — Asset → KML / GeoJSON / Shapefile / Map PDF</h1>
      <p class="sub">Fast one-offs or bulk lists. Converts ArcGIS features to KML, GeoJSON, or zipped Shapefile via Mapshaper. Now with Map PDF.</p>

      <div class="tabs">
        <button id="tabSingle" class="tab active">Single</button>
        <button id="tabBulk" class="tab">Bulk</button>
      </div>

      <!-- Single -->
      <section id="single" class="card">
        <div class="grid">
          <div>
            <label>ASSET / BMP ID</label>
            <input id="asset" placeholder="e.g., WP0399, 210049UT, LOD_12345" />
          </div>
          <div>
            <label>DATASET</label>
            <select id="dataset">
              <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
              <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
              <option disabled>──────────</option>
              <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
              <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
              <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
              <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
              <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
              <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
            </select>
          </div>
          <div>
            <label>FORMAT</label>
            <select id="format">
              <option>KML</option>
              <option>GeoJSON</option>
              <option>Shapefile (.zip)</option>
              <option>Map PDF</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <button id="downloadBtn" class="btn">Download</button>
          <a id="gmapsLink" class="link" href="#" target="_blank" rel="noopener" style="display:none">Open in Google Maps</a>
          <button id="copyBtn" class="btn sm" disabled>Copy link</button>
          <div id="status" class="status muted"></div>
        </div>

        <div class="row" style="margin-top:14px">
          <span class="note"><strong>Note</strong> MDOT SHA layers may require VPN. MapBuddy saves your last choices locally.</span>
        </div>
      </section>

      <!-- Bulk -->
      <section id="bulk" class="card" style="display:none; margin-top:16px">
        <div class="bulk-grid">
          <div>
            <label>Paste CSV rows <span class="muted">(header optional; columns: <code>assetId</code> or <code>assetId,dataset</code>)</span></label>
            <textarea id="bulkRows" class="bulk-rows" placeholder="0256DP
0352DP
WP0399
210049UT,mdsha_tmdl_tree_plantings"></textarea>
          </div>
          <div>
            <label>Upload CSV file</label>
            <input id="bulkFile" type="file" accept=".csv,text/csv" />
            <div style="height:14px"></div>
            <label>Default dataset <span class="muted">(applies to rows without a dataset)</span></label>
            <select id="bulkDefault">
              <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
              <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>
              <option disabled>──────────</option>
              <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
              <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
              <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
              <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
              <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
              <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
            </select>
            <div style="height:14px"></div>
            <label>Format</label>
            <select id="bulkFormat">
              <option>KML (.zip)</option>
              <option>GeoJSON (.zip)</option>
              <option>Shapefile (.zip)</option>
            </select>
            <div style="height:14px"></div>
            <button id="bulkBtn" class="btn">Download</button>
            <div id="bulkStatus" class="status muted" style="margin-top:8px"></div>
          </div>
        </div>
      </section>
    </div>

    <script>
      // ---------- tab switching
      const $ = (id) => document.getElementById(id);
      const tabSingle = $("tabSingle"), tabBulk = $("tabBulk");
      const single = $("single"), bulk = $("bulk");
      tabSingle.onclick = () => { tabSingle.classList.add("active"); tabBulk.classList.remove("active"); single.style.display="block"; bulk.style.display="none"; };
      tabBulk.onclick   = () => { tabBulk.classList.add("active"); tabSingle.classList.remove("active"); bulk.style.display="block"; single.style.display="none"; };

      // ---------- persist basic choices
      const LS = {
        get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def }catch{ return def } },
        set(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)) }catch{} }
      };
      ["dataset","format"].forEach(id => $(id).value = LS.get("single."+id, $(id).value));
      $("dataset").onchange = () => LS.set("single.dataset", $("dataset").value);
      $("format").onchange  = () => LS.set("single.format", $("format").value);
      $("bulkDefault").value = LS.get("bulk.default", $("bulkDefault").value);
      $("bulkFormat").value  = LS.get("bulk.format", $("bulkFormat").value);
      $("bulkDefault").onchange = () => LS.set("bulk.default", $("bulkDefault").value);
      $("bulkFormat").onchange  = () => LS.set("bulk.format", $("bulkFormat").value);

      // ---------- helpers
      function fileDownload(blob, name){
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = name;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }
      async function locate(assetId, dataset){
        const r = await fetch("/api/locate", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ assetId, dataset })
        });
        if(!r.ok) throw new Error("Locate failed");
        return r.json();
      }

      // ---------- Single: download
      const formatMapSingle = {
        "KML": "kml",
        "GeoJSON": "geojson",
        "Shapefile (.zip)": "shpzip",
        "Map PDF": "pdf" // just a marker for UI; actual call is /api/map-pdf
      };

      $("downloadBtn").onclick = handleSingle;
      $("asset").addEventListener("keydown", (e)=>{ if(e.key==="Enter") handleSingle(); });

      async function handleSingle(){
        const asset   = $("asset").value.trim();
        const dataset = $("dataset").value;
        const format  = $("format").value;
        const status  = $("status");
        const gmLink  = $("gmapsLink");
        const copyBtn = $("copyBtn");

        if(!asset){ status.textContent = "Enter an Asset / BMP ID."; return; }

        $("downloadBtn").disabled = true; copyBtn.disabled = true; status.textContent = "Locating…";

        // 1) Get Google Maps link first (for all formats)
        try {
          const info = await locate(asset, dataset);
          if (info?.googleMapsUrl) {
            gmLink.href = info.googleMapsUrl; gmLink.style.display = "inline";
            copyBtn.disabled = false;
            copyBtn.onclick = async () => {
              await navigator.clipboard.writeText(info.googleMapsUrl);
              const t = copyBtn.textContent; copyBtn.textContent = "Copied!";
              setTimeout(()=> copyBtn.textContent = t, 900);
            };
          }
        } catch(_) { /* link optional */ }

        // 2) Download per format
        try {
          status.textContent = (format === "Map PDF") ? "Rendering map…" : "Converting…";

          if (format === "Map PDF"){
            const r = await fetch("/api/map-pdf", {
              method:"POST", headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ assetId: asset, dataset })
            });
            if(!r.ok){
              let msg = `Request failed (${r.status})`;
              try{ const e = await r.json(); if(e?.error) msg = e.error; }catch{}
              throw new Error(msg);
            }
            const blob = await r.blob();
            fileDownload(blob, `${asset}_map.pdf`);
          } else {
            const r = await fetch("/api/convert", {
              method:"POST", headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ assetId: asset, dataset, format: formatMapSingle[format] })
            });
            if(!r.ok){
              let msg = `Request failed (${r.status})`;
              try{ const e = await r.json(); if(e?.error) msg = e.error; }catch{}
              throw new Error(msg);
            }
            const blob = await r.blob();
            const ext = (format === "Shapefile (.zip)") ? "zip" : (format === "GeoJSON" ? "geojson" : "kml");
            fileDownload(blob, `${asset}.${ext}`);
          }
          status.textContent = "";
        } catch(err){
          status.textContent = err.message || "Error";
        } finally {
          $("downloadBtn").disabled = false;
        }
      }

      // ---------- Bulk: paste or upload -> zip
      $("bulkFile").addEventListener("change", async (e)=>{
        const f = e.target.files?.[0]; if(!f) return;
        const txt = await f.text();
        $("bulkRows").value = txt.trim();
      });

      $("bulkBtn").onclick = handleBulk;

      const formatMapBulk = {
        "KML (.zip)": "kmlzip",
        "GeoJSON (.zip)": "geojsonzip",
        "Shapefile (.zip)": "shpzip"
      };

      async function handleBulk(){
        const rows = $("bulkRows").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const def  = $("bulkDefault").value;
        const fmt  = $("bulkFormat").value;
        const status = $("bulkStatus");

        if(!rows.length){ status.textContent = "Nothing to convert — add some rows."; return; }

        const items = rows.map(line=>{
          const parts = line.split(",").map(s=>s.trim()).filter(Boolean);
          return (parts.length>=2) ? { assetId: parts[0], dataset: parts[1] } : { assetId: parts[0] };
        });

        $("bulkBtn").disabled = true; status.textContent = "Converting…";
        try{
          const r = await fetch("/api/bulk", {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ items, defaultDataset: def, format: formatMapBulk[fmt] })
          });
          if(!r.ok){
            let msg = `Request failed (${r.status})`;
            try{ const e = await r.json(); if(e?.error) msg = e.error; }catch{}
            throw new Error(msg);
          }
          const blob = await r.blob();
          const base = fmt.startsWith("KML") ? "mapbuddy_kml" : (fmt.startsWith("GeoJSON") ? "mapbuddy_geojson" : "mapbuddy_shapefile");
          fileDownload(blob, `${base}.zip`);
          status.textContent = "Done.";
        } catch(err){
          status.textContent = err.message || "Error";
        } finally {
          $("bulkBtn").disabled = false;
        }
      }
    </script>
  </body>
</html>
