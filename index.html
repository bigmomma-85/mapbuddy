<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MapBuddy — Asset → KML / GeoJSON / Shapefile / Map PDF</title>
    <style>
      :root{
        --bg:#f4f9fb;
        --card:#ffffff;
        --ink:#0b1220;
        --muted:#5b6b7a;
        --brand:#0b72ff;
        --brand-ink:#0b3da8;
        --ok:#15a361;
        --ring: 0 8px 30px rgba(10,40,80,.08);
      }
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink)}
      .wrap{max-width:1150px;margin:40px auto;padding:0 20px}
      h1{font-weight:800;letter-spacing:.2px;margin:0 0 8px;font-size:44px;color:#113656}
      .lead{color:var(--muted);margin:0 0 28px}
      .seg{display:flex;gap:10px;justify-content:flex-end;margin-top:-58px}
      .seg button{padding:10px 16px;border-radius:999px;border:1px solid #d6e0ea;background:#fff;color:#294463;cursor:pointer}
      .seg button.active{background:#113656;color:#fff;border-color:#113656}
      .card{background:var(--card);border:1px solid #e8eef4;border-radius:16px;padding:18px 18px 22px;box-shadow:var(--ring)}
      .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
      label{display:block;font-size:12px;letter-spacing:.02em;color:#4a5a6b;margin:6px 2px}
      input,select,textarea{width:100%;padding:13px 12px;border:1px solid #cfdae6;border-radius:10px;background:#fff;font-size:16px}
      textarea{min-height:260px;resize:vertical}
      .row{margin-top:6px}
      .actions{display:flex;gap:12px;align-items:center;margin-top:12px}
      .btn{padding:14px 20px;border:0;border-radius:10px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
      .btn:hover{background:#0a63db}
      .note{margin-top:12px;font-size:14px;color:#4f5b69;display:flex;gap:10px;align-items:center}
      .chip{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #e0e7f0;background:#f6fbff;color:#274a72}
      .right{display:flex;justify-content:flex-end}
      .muted{color:var(--muted)}
      .hint{font-size:12px;color:#6b7a8a}
      .tiny{font-size:12px}
      .ok{color:var(--ok)}
      @media (max-width:980px){
        .seg{margin-top:8px;justify-content:flex-start}
        .grid{grid-template-columns:1fr}
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>MapBuddy — Asset → KML / GeoJSON / Shapefile / Map PDF</h1>
      <p class="lead">Fast one-offs or bulk lists. Converts ArcGIS features to KML, GeoJSON, or zipped Shapefile via Mapshaper. Now with Map PDF.</p>

      <div class="seg">
        <button class="active" id="tabSingle">Single</button>
        <button id="tabBulk">Bulk</button>
      </div>

      <!-- SINGLE -->
      <div class="card" id="singleCard">
        <div class="grid">
          <div>
            <label>ASSET / BMP ID</label>
            <input id="asset" placeholder="e.g., WP0399, 210049UT, LOD_12345" />
          </div>
          <div>
            <label>DATASET</label>
            <select id="dataset">
              <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
              <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>

              <optgroup label="MD SHA — TMDL">
                <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
                <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
                <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
                <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
                <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
                <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
              </optgroup>
            </select>
          </div>
          <div>
            <label>FORMAT</label>
            <select id="formatSingle">
              <option value="kml">KML</option>
              <option value="geojson">GeoJSON</option>
              <option value="shpzip">Shapefile (.zip)</option>
              <option value="mappdf">Map PDF</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnDownload">Download</button>
          <span id="status" class="muted"></span>
          <span id="mapsLink" class="tiny"></span>
          <button id="btnCopyLink" class="chip" title="Copy Google Maps link">Copy link</button>
        </div>

        <div class="note"><span class="chip">Note</span> MDOT SHA layers may require VPN. MapBuddy saves your last choices locally.</div>
      </div>

      <!-- BULK -->
      <div class="card" id="bulkCard" style="display:none">
        <div class="grid">
          <div style="grid-column:1 / span 2">
            <label>Paste CSV rows <span class="hint">(header optional; columns: <b>assetId</b> or <b>assetId,dataset</b>)</span></label>
            <textarea id="bulkText" placeholder="WP0399&#10;210049UT,mdsha_tmdl_tree_plantings"></textarea>
          </div>
          <div>
            <label>Upload CSV file</label>
            <div style="border:1px dashed #cfd8e5;border-radius:10px;padding:16px;text-align:center;color:#6e7b8a">
              <input id="bulkFile" type="file" accept=".csv" />
              <div class="hint">Drop CSV here or click to choose</div>
            </div>
          </div>
        </div>

        <div class="grid row">
          <div>
            <label>Default dataset <span class="hint">(applies to rows without a dataset)</span></label>
            <select id="bulkDefault">
              <option value="fairfax_bmps">Fairfax — Stormwater Facilities (FACILITY_ID)</option>
              <option value="mdsha_landscape">MDOT SHA — Managed Landscape (LOD_ID)</option>

              <optgroup label="MD SHA — TMDL">
                <option value="mdsha_tmdl_structures">TMDL — Stormwater Control Structures</option>
                <option value="mdsha_tmdl_retrofits">TMDL — Retrofits</option>
                <option value="mdsha_tmdl_tree_plantings">TMDL — Tree Plantings</option>
                <option value="mdsha_tmdl_pavement_removals">TMDL — Pavement Removals</option>
                <option value="mdsha_tmdl_stream_restorations">TMDL — Stream Restorations</option>
                <option value="mdsha_tmdl_outfall_stabilizations">TMDL — Outfall Stabilizations</option>
              </optgroup>
            </select>
          </div>
          <div>
            <label>Format</label>
            <select id="formatBulk">
              <option value="kmlzip">KML (.zip)</option>
              <option value="geojsonzip">GeoJSON (.zip)</option>
              <option value="shpzip">Shapefile (.zip)</option>
            </select>
          </div>
          <div class="right" style="align-items:end">
            <button class="btn" id="btnBulk">Download</button>
          </div>
        </div>

        <div class="ok tiny" id="bulkOk" style="display:none">Done.</div>
      </div>
    </div>

    <script>
      const $ = (sel) => document.querySelector(sel);

      const tabSingle = $('#tabSingle');
      const tabBulk   = $('#tabBulk');
      const cardSingle= $('#singleCard');
      const cardBulk  = $('#bulkCard');

      tabSingle.onclick = () => { tabSingle.classList.add('active'); tabBulk.classList.remove('active'); cardSingle.style.display='block'; cardBulk.style.display='none'; };
      tabBulk.onclick   = () => { tabBulk.classList.add('active'); tabSingle.classList.remove('active'); cardSingle.style.display='none'; cardBulk.style.display='block'; };

      const assetEl = $('#asset');
      const datasetEl = $('#dataset');
      const formatSingleEl = $('#formatSingle');
      const statusEl = $('#status');
      const mapsLinkEl = $('#mapsLink');
      const btnCopy = $('#btnCopyLink');

      // persist last choices
      const LS = 'mapbuddy:last';
      const last = JSON.parse(localStorage.getItem(LS) || '{}');
      if (last.asset) assetEl.value = last.asset;
      if (last.dataset) datasetEl.value = last.dataset;
      if (last.formatSingle) formatSingleEl.value = last.formatSingle;

      function saveLast() {
        localStorage.setItem(LS, JSON.stringify({
          asset: assetEl.value.trim(),
          dataset: datasetEl.value,
          formatSingle: formatSingleEl.value
        }));
      }

      async function locate(asset, dataset) {
        const r = await fetch('/api/locate', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ assetId: asset, dataset })
        });
        if (!r.ok) throw new Error(`Locate failed (${r.status})`);
        return r.json();
      }

      async function singleDownload() {
        const asset = assetEl.value.trim();
        const dataset = datasetEl.value;
        const fmt = formatSingleEl.value;
        if (!asset) { statusEl.textContent='Please enter an Asset / BMP ID.'; return; }

        saveLast();
        statusEl.textContent='Locating…';
        mapsLinkEl.textContent='';

        let info=null;
        try {
          info = await locate(asset, dataset);
          if (info?.googleMapsUrl) {
            mapsLinkEl.innerHTML = `<a href="${info.googleMapsUrl}" target="_blank" rel="noopener">Open in Google Maps</a>`;
            btnCopy.onclick = () => navigator.clipboard.writeText(info.googleMapsUrl);
          }
        } catch(e){ /* continue even if locate fails */ }

        try {
          statusEl.textContent = (fmt === 'mappdf') ? 'Rendering map…' : 'Converting…';

          const endpoint = (fmt === 'mappdf') ? '/api/map-pdf' : '/api/convert';
          const body = (fmt === 'mappdf')
            ? { assetId: asset, dataset }
            : { assetId: asset, dataset, format: fmt };

          const resp = await fetch(endpoint, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });

          if (!resp.ok) {
            let msg = `Request failed (${resp.status})`;
            try { const err = await resp.json(); if (err?.error) msg = err.error; } catch {}
            throw new Error(msg);
          }

          // download
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const ext = (fmt === 'mappdf') ? 'pdf' : (fmt==='shpzip'?'zip':fmt);
          a.href = url;
          a.download = `${asset}.${ext}`;
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);

          statusEl.textContent = 'Done.';
        } catch (e) {
          statusEl.textContent = e.message || 'Error';
        }
      }

      $('#btnDownload').onclick = singleDownload;

      // --- Bulk (unchanged behavior; still returns zip + maps CSV) -------------
      const bulkText = $('#bulkText');
      const bulkFile = $('#bulkFile');
      const bulkDefault = $('#bulkDefault');
      const formatBulk = $('#formatBulk');
      const bulkOk = $('#bulkOk');

      bulkFile.addEventListener('change', async (e)=>{
        const f = e.target.files?.[0];
        if (!f) return;
        const text = await f.text();
        bulkText.value = text;
      });

      $('#btnBulk').onclick = async ()=>{
        bulkOk.style.display='none';

        const rows = bulkText.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const items = rows.map(line=>{
          const [assetId, ds] = line.split(',').map(s=>s?.trim());
          return ds ? { assetId, dataset: ds } : { assetId };
        });

        const body = {
          items,
          defaultDataset: bulkDefault.value,
          format: formatBulk.value
        };

        const r = await fetch('/api/bulk', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });

        if (!r.ok) {
          let msg = `Bulk failed (${r.status})`;
          try { const err = await r.json(); if (err?.error) msg = err.error; } catch {}
          alert(msg); return;
        }

        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'mapbuddy.zip';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);

        bulkOk.style.display='inline';
      };
    </script>
  </body>
</html>
