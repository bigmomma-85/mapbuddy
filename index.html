<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MapBuddy — Convert Assets to Map Files</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mbBlue: "#2563eb",
            mbGreen: "#059669",
          },
          boxShadow: {
            soft: "0 10px 30px rgba(2, 6, 23, 0.06)",
          },
        },
      },
    };
  </script>

  <style>
    /* Gradient pill buttons */
    .btn-grad {
      @apply inline-flex items-center justify-center rounded-full px-5 py-3
             text-white font-semibold shadow-soft transition-transform
             active:scale-[.98] disabled:opacity-50 disabled:cursor-not-allowed;
      background: linear-gradient(90deg, #2563eb 0%, #059669 100%);
    }
    .seg-btn {
      @apply rounded-full px-6 py-2 font-semibold shadow-soft;
    }
    .seg-on {
      background: linear-gradient(90deg, #2563eb 0%, #059669 100%);
      @apply text-white;
    }
    .seg-off { @apply bg-white text-slate-700; }

    /* Card */
    .card {
      @apply bg-white rounded-2xl shadow-soft border border-slate-100;
    }

    /* Inputs / selects */
    .mb-input {
      @apply w-full rounded-xl border border-slate-300 bg-white px-4 py-3 shadow-sm
             focus:outline-none focus:ring-2 focus:ring-mbBlue/30 focus:border-mbBlue;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 text-slate-900">
  <!-- Header -->
  <header class="w-full bg-transparent">
    <div class="max-w-6xl mx-auto px-4 py-6 flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold"
           style="background: linear-gradient(135deg,#2563eb 0%,#059669 100%)">
        M
      </div>
      <div class="text-2xl font-semibold">MapBuddy</div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-6xl mx-auto px-4 pt-4 pb-6">
    <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">
      Convert Assets to
      <span class="text-transparent bg-clip-text"
            style="background: linear-gradient(90deg,#2563eb 0%,#059669 100%);">
        Map Files
      </span>
    </h1>
    <p class="mt-4 text-lg text-slate-600 max-w-3xl">
      Transform asset numbers into KML, GeoJSON, Shapefile. Single asset or bulk processing available.
    </p>

    <!-- Mode toggle -->
    <div class="mt-6 flex gap-3">
      <button id="btnSingle" class="seg-btn seg-on">Single</button>
      <button id="btnBulk" class="seg-btn seg-off">Bulk</button>
    </div>
  </section>

  <!-- Single Card -->
  <section id="singleCard" class="max-w-6xl mx-auto px-4">
    <div class="card p-6">
      <div class="grid lg:grid-cols-12 gap-6">
        <!-- Asset -->
        <div class="lg:col-span-4">
          <label class="block text-sm font-medium mb-2">Asset / BMP ID</label>
          <input id="singleAsset" type="text"
                 placeholder="e.g., WP0399, 210049UT, LOD_12345"
                 class="mb-input" />
        </div>

        <!-- Dataset -->
        <div class="lg:col-span-5">
          <label class="block text-sm font-medium mb-2">Dataset</label>
          <select id="singleDataset" class="mb-input">
            <!-- Fairfax -->
            <option value="fairfax_bmps">
              Fairfax — Stormwater Facilities (FACILITY_ID)
            </option>

            <!-- MDOT SHA — TMDL group -->
            <option value="mdsha_tmdl_scs">
              MDOT SHA — TMDL — Stormwater Control Structures
            </option>
            <option value="mdsha_tmdl_retrofits">
              MDOT SHA — TMDL — Retrofits
            </option>
            <option value="mdsha_tmdl_tree_plantings">
              MDOT SHA — TMDL — Tree Plantings
            </option>
            <option value="mdsha_tmdl_pavement_removals">
              MDOT SHA — TMDL — Pavement Removals
            </option>
            <option value="mdsha_tmdl_stream_restorations">
              MDOT SHA — TMDL — Stream Restorations
            </option>
            <option value="mdsha_tmdl_outfall_stabilizations">
              MDOT SHA — TMDL — Outfall Stabilizations
            </option>

            <!-- MDOT SHA Landscape -->
            <option value="mdsha_managed_landscape">
              MDOT SHA — Managed Landscape (LOD_ID)
            </option>
          </select>
        </div>

        <!-- Format -->
        <div class="lg:col-span-3">
          <label class="block text-sm font-medium mb-2">Format</label>
          <select id="singleFormat" class="mb-input">
            <option value="kml">KML</option>
            <option value="geojson">GeoJSON</option>
            <option value="shapefile">Shapefile (.zip)</option>
          </select>
        </div>
      </div>

      <!-- Actions -->
      <div class="mt-6 flex flex-wrap items-center gap-4">
        <button id="btnSingleDownload" class="btn-grad">Download</button>

        <a id="googleLink"
           class="hidden text-mbBlue hover:underline"
           href="#"
           target="_blank"
           rel="noopener noreferrer">
          Open in Google Maps →
        </a>

        <button id="btnCopyLink" class="btn-grad" disabled>Copy link</button>

        <span id="singleNote" class="text-sm text-slate-500">
          Enter an asset ID.
        </span>
      </div>

      <div class="mt-4">
        <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-medium text-slate-600 mr-2">Note</span>
        <span class="text-sm text-slate-600">MDOT SHA layers may require VPN.</span>
      </div>
    </div>

    <footer class="text-center text-slate-500 text-sm py-12">
      © 2025 MapBuddy · Simple, reliable asset-to-map conversion.
    </footer>
  </section>

  <!-- Bulk Card -->
  <section id="bulkCard" class="max-w-6xl mx-auto px-4 hidden">
    <div class="card p-6">
      <h3 class="text-xl font-semibold mb-4">Bulk Asset Conversion</h3>

      <div class="grid lg:grid-cols-12 gap-6">
        <!-- Dataset -->
        <div class="lg:col-span-6">
          <label class="block text-sm font-medium mb-2">Dataset</label>
          <select id="bulkDataset" class="mb-input">
            <option value="fairfax_bmps">
              Fairfax — Stormwater Facilities (FACILITY_ID)
            </option>

            <option value="mdsha_tmdl_scs">
              MDOT SHA — TMDL — Stormwater Control Structures
            </option>
            <option value="mdsha_tmdl_retrofits">
              MDOT SHA — TMDL — Retrofits
            </option>
            <option value="mdsha_tmdl_tree_plantings">
              MDOT SHA — TMDL — Tree Plantings
            </option>
            <option value="mdsha_tmdl_pavement_removals">
              MDOT SHA — TMDL — Pavement Removals
            </option>
            <option value="mdsha_tmdl_stream_restorations">
              MDOT SHA — TMDL — Stream Restorations
            </option>
            <option value="mdsha_tmdl_outfall_stabilizations">
              MDOT SHA — TMDL — Outfall Stabilizations
            </option>

            <option value="mdsha_managed_landscape">
              MDOT SHA — Managed Landscape (LOD_ID)
            </option>
          </select>
        </div>

        <!-- Format -->
        <div class="lg:col-span-6">
          <label class="block text-sm font-medium mb-2">Output Format</label>
          <select id="bulkFormat" class="mb-input">
            <option value="kmlzip">KML (.zip)</option>
            <option value="geojsonzip">GeoJSON (.zip)</option>
            <option value="shapefile">Shapefile (.zip)</option>
          </select>
        </div>

        <!-- CSV Dropzone -->
        <div class="lg:col-span-7">
          <div id="dropArea"
               class="border-2 border-dashed border-slate-300 rounded-2xl p-8 text-center hover:border-mbBlue transition-colors cursor-pointer">
            <div class="mx-auto w-12 h-12 rounded-full flex items-center justify-center text-white mb-4"
                 style="background: linear-gradient(135deg,#2563eb 0%,#059669 100%)">
              <!-- upload icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
            </div>
            <h4 class="text-lg font-semibold mb-1">Drop your CSV file here</h4>
            <p class="text-slate-500 mb-4">or click to browse</p>
            <button id="btnChooseCsv" class="btn-grad">Choose CSV File</button>
            <input id="csvInput" type="file" accept=".csv" class="hidden" />
            <p id="csvStatus" class="mt-4 text-sm text-slate-600"></p>
          </div>

          <div class="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-4 text-blue-900">
            <h5 class="font-semibold mb-2">CSV Format Requirements:</h5>
            <ul class="list-disc ml-5 space-y-1 text-sm">
              <li>First column: Asset numbers</li>
              <li>Header row optional</li>
              <li>Up to 1000 assets per file</li>
              <li>Optional second column: dataset key</li>
            </ul>
          </div>
        </div>

        <!-- Bulk action -->
        <div class="lg:col-span-5">
          <div class="h-full flex items-end">
            <button id="btnBulkProcess" class="btn-grad w-full">Process Bulk Conversion</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center text-slate-500 text-sm py-12">
      © 2025 MapBuddy · Simple, reliable asset-to-map conversion.
    </footer>
  </section>

  <!-- Scripts -->
  <script>
    // Elements
    const btnSingle = document.getElementById('btnSingle');
    const btnBulk = document.getElementById('btnBulk');
    const singleCard = document.getElementById('singleCard');
    const bulkCard = document.getElementById('bulkCard');

    const singleAsset = document.getElementById('singleAsset');
    const singleDataset = document.getElementById('singleDataset');
    const singleFormat = document.getElementById('singleFormat');
    const btnSingleDownload = document.getElementById('btnSingleDownload');
    const btnCopyLink = document.getElementById('btnCopyLink');
    const googleLink = document.getElementById('googleLink');
    const singleNote = document.getElementById('singleNote');

    const bulkDataset = document.getElementById('bulkDataset');
    const bulkFormat = document.getElementById('bulkFormat');
    const btnChooseCsv = document.getElementById('btnChooseCsv');
    const csvInput = document.getElementById('csvInput');
    const dropArea = document.getElementById('dropArea');
    const csvStatus = document.getElementById('csvStatus');
    const btnBulkProcess = document.getElementById('btnBulkProcess');

    let lastGmapsUrl = "";

    // Mode switch
    function setMode(mode) {
      if (mode === 'single') {
        btnSingle.classList.replace('seg-off', 'seg-on');
        btnBulk.classList.replace('seg-on', 'seg-off');
        singleCard.classList.remove('hidden');
        bulkCard.classList.add('hidden');
      } else {
        btnBulk.classList.replace('seg-off', 'seg-on');
        btnSingle.classList.replace('seg-on', 'seg-off');
        bulkCard.classList.remove('hidden');
        singleCard.classList.add('hidden');
      }
      // hide google link until a single success happens
      lastGmapsUrl = "";
      setGoogleLinkVisible(false);
      btnCopyLink.disabled = true;
      singleNote.textContent = "Enter an asset ID.";
    }

    btnSingle.addEventListener('click', () => setMode('single'));
    btnBulk.addEventListener('click', () => setMode('bulk'));

    function setGoogleLinkVisible(show) {
      googleLink.classList.toggle('hidden', !show);
    }

    // Build Google Maps link (simple search by ID text)
    function buildGmapsUrl(assetId) {
      const q = encodeURIComponent(assetId);
      return `https://www.google.com/maps/search/?api=1&query=${q}`;
    }

    // SINGLE: Download
    btnSingleDownload.addEventListener('click', async () => {
      const assetId = (singleAsset.value || "").trim();
      const dataset = singleDataset.value;
      const format = singleFormat.value; // kml | geojson | shapefile

      if (!assetId) {
        singleNote.textContent = "Please enter an asset ID.";
        return;
      }

      singleNote.textContent = "Working…";

      try {
        const res = await fetch('/api/convert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            assetId,
            dataset,
            format
          })
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || `Request failed (${res.status})`);
        }

        // Download file
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        // Name
        const ext = format === 'kml' ? 'kml'
                 : format === 'geojson' ? 'geojson'
                 : 'zip';
        const fname = `${assetId}.${ext}`;

        const a = document.createElement('a');
        a.href = url;
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        // Enable Google link + Copy link now
        lastGmapsUrl = buildGmapsUrl(assetId);
        googleLink.href = lastGmapsUrl;
        setGoogleLinkVisible(true);
        btnCopyLink.disabled = false;

        singleNote.textContent = "Done.";
      } catch (err) {
        singleNote.textContent = "Error: " + (err?.message || "Request failed");
        setGoogleLinkVisible(false);
        btnCopyLink.disabled = true;
      }
    });

    // SINGLE: Copy link
    btnCopyLink.addEventListener('click', async () => {
      if (!lastGmapsUrl) return;
      try {
        await navigator.clipboard.writeText(lastGmapsUrl);
        btnCopyLink.textContent = "Copied!";
        setTimeout(() => (btnCopyLink.textContent = "Copy link"), 1200);
      } catch {
        btnCopyLink.textContent = "Copy failed";
        setTimeout(() => (btnCopyLink.textContent = "Copy link"), 1200);
      }
    });

    // BULK: CSV handling
    function chooseCsv() { csvInput.click(); }
    btnChooseCsv.addEventListener('click', chooseCsv);
    dropArea.addEventListener('click', chooseCsv);

    csvInput.addEventListener('change', () => {
      if (!csvInput.files?.length) return;
      const f = csvInput.files[0];
      csvStatus.textContent = `Selected: ${f.name}`;
    });

    // Parse CSV simple: first column assetId, optional second column dataset
    function parseCsvToItems(csvText) {
      const lines = csvText.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (!lines.length) return [];
      const looksLikeHeader = /asset/i.test(lines[0]) || /dataset/i.test(lines[0]);
      const rows = looksLikeHeader ? lines.slice(1) : lines;

      return rows.map(line => {
        const parts = line.split(',').map(s => s.trim());
        const assetId = parts[0] || "";
        const dataset = parts[1] || "";
        return assetId ? { assetId, dataset } : null;
      }).filter(Boolean);
    }

    async function processBulk() {
      if (!csvInput.files?.length) {
        csvStatus.textContent = "Please choose a CSV file.";
        return;
      }
      const file = csvInput.files[0];
      const text = await file.text();
      const items = parseCsvToItems(text);
      if (!items.length) {
        csvStatus.textContent = "No valid rows found.";
        return;
      }

      const defaultDataset = bulkDataset.value;
      const format = bulkFormat.value; // kmlzip | geojsonzip | shapefile

      csvStatus.textContent = "Processing…";
      btnBulkProcess.disabled = true;

      try {
        const res = await fetch('/api/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items, defaultDataset, format })
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || `Request failed (${res.status})`);
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const fname = format === 'kmlzip' ? 'mapbuddy_kml.zip'
                    : format === 'geojsonzip' ? 'mapbuddy_geojson.zip'
                    : 'mapbuddy_shapefile.zip';

        const a = document.createElement('a');
        a.href = url;
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        csvStatus.textContent = "Done.";
      } catch (err) {
        csvStatus.textContent = "Error: " + (err?.message || "Request failed");
      } finally {
        btnBulkProcess.disabled = false;
      }
    }

    btnBulkProcess.addEventListener('click', processBulk);

    // Default mode
    setMode('single');
  </script>
</body>
</html>
